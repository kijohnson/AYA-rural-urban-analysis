---
#R VERSION: 3.5.0
#PROJECT: Manuscript entitled "Impact of geographic factors on AYA stage at diagnosis"
#PURPOSE: Code to generate results in paper
#AUTHORS: Kim Johnson 
#CREATED: August 5, 2019
#LATEST:  "`r format(Sys.time(), '%d %B, %Y')`" 
#NOTES:   
editor_options: 
  chunk_output_type: inline
---
#Load packages and open libraries used for the analysis
```{r setup, include=FALSE}
#install.packages("survminer") #for pairwise diffs
#install.packages("survival")  #for calculating KM values
#install.packages("ggplot") #for plotting KM curve
#install.packages("table1")
#install.packages("frequency")
#install.packages("expss") # for variable labelling
#install.packages("mice") #Install mice package for imputed missing data
#install.packages("lattice")
#install.packages("dichromat")
#install.packages("odds.n.ends")
#install.packages("lmtest")
#install.packages("gridExtra")
#install.packages("openxlsx")
library(openxlsx)
library(lmtest)
library(odds.n.ends)
library(lattice)
library(survival)
library(survminer) 
library(ggplot2) 
library(table1)
library(frequency)
library(expss)
library(dichromat)
library(gridExtra)
library(lmtest)
```

#Load data from Box
```{r}
#original location
#AYAcancer_type <- read.csv("/Users/kijohnson/Box/From Box/NCDB  (PUF) 2015.1198/NCDB 2015.1198 (all files)/NCDB1198ALLv2_cancertype.csv") #cancer case data with AYA coding
AYA<-read.csv("NCDB1198ALLv2_cancertype.csv")
```
#Data management
```{r}
#variables needed: age group, RUCA codes, Urban/rural 2013, sex, race, insurance, income, Percent w/o highschool degree, cancer type, distance from cancer center

#make age groups
AYA$Age_cat[AYA$AGE>=15 & AYA$AGE<20] <- 0
AYA$Age_cat[AYA$AGE>=20 & AYA$AGE<25] <- 1
AYA$Age_cat[AYA$AGE>=25 & AYA$AGE<30] <- 2
AYA$Age_cat[AYA$AGE>=30 & AYA$AGE<35] <- 3
AYA$Age_cat[AYA$AGE>=35] <- 4
AYA$Age_cat<-factor(AYA$Age_cat,levels=c(0:4),labels=c("15-19","20-24","25-29","30-34", "35-39"))
table(AYA$Age_cat, useNA="always")

#recode sex
AYA$SEX[AYA$SEX==1] <- 1 #males coded as 1
AYA$SEX[AYA$SEX==2] <- 0 #females coded as 0
AYA$SEX<- factor(AYA$SEX,levels=c(1:0),labels=c("Male","Female"))
table(AYA$SEX, useNA="always")

#recode race/ethnicity
#Code for White 1
#Code for Black 2
#Code for Other >=3 and !=99 (Unknown)
AYA$RACE[AYA$RACE==1 & AYA$SPANISH_HISPANIC_ORIGIN==0]<-0
AYA$RACE[AYA$RACE==2 & AYA$SPANISH_HISPANIC_ORIGIN==0]<-1
AYA$RACE[AYA$RACE>=3 & AYA$RACE<99 & AYA$SPANISH_HISPANIC_ORIGIN==0]<-2
AYA$RACE[AYA$SPANISH_HISPANIC_ORIGIN>0 &  AYA$SPANISH_HISPANIC_ORIGIN<9]<-3
AYA$RACE<- factor(AYA$RACE,levels=c(0:3),labels=c("Non-Hispanic White","Non-Hispanic Black","Non-Hispanic Other", "Hispanic"))
table(AYA$RACE, useNA="always")

#label primary payer
AYA$insurance<-factor(AYA$INSURANCE_STATUS, levels=c(0:4), labels=c("Not Insured", "Private Insurance/Managed Care", "Medicaid", "Medicare", "Other Government"))
table(AYA$insurance, useNA="always")

#label analytic stage
AYA$stage<-factor(AYA$ANALYTIC_STAGE_GROUP, levels=c(0,1,2,3,4,5,8,9), labels=c("Stage 0", "Stage I", "Stage II", "Stage III", "Stage IV", "Occult (lung only)", "AJCC Staging Not Applicable", "AJCC Staging Unknown"))
table(AYA$stage, useNA="always")

#create early and late stage group (exclude stage 0 and Occult (lung only))
AYA$stage_binary[AYA$stage=="Stage I"|AYA$stage=="Stage II"]<-0
AYA$stage_binary[AYA$stage=="Stage III"|AYA$stage=="Stage IV"]<-1
AYA$stage_binary<-factor(AYA$stage_binary, levels=c(0,1), labels=c("Early", "Late"))
table(AYA$stage_binary, useNA="always")

#education quartiles (This measure of educational attainment for each patient's area of residence is estimated by matching the zip code of the patient recorded at the time of diagnosis against files derived from the 2012 American Community Survey data, spanning years 2008-2012. 
AYA$educ[AYA$NO_HSD_QUAR_12==1]<-0
AYA$educ[AYA$NO_HSD_QUAR_12==2]<-1
AYA$educ[AYA$NO_HSD_QUAR_12==3]<-2
AYA$educ[AYA$NO_HSD_QUAR_12==4]<-3
AYA$educ<-factor(AYA$educ, levels=c(0:3), labels=c("21% or more", "13%-20.9%", "7%-12.9%", "Less than 7%"))
table(AYA$educ, useNA="always")


#income quartiles 2008-2012 (Median household income for each patient's area of residence is estimated by matching the zip code of the patient recorded at the time of diagnosis against files derived from the 2012 American Community Survey data, spanning years 2008-2012 and adjusted for 2012 inflation.)
AYA$income[AYA$MED_INC_QUAR_12==1]<-0
AYA$income[AYA$MED_INC_QUAR_12==2]<-1
AYA$income[AYA$MED_INC_QUAR_12==3]<-2
AYA$income[AYA$MED_INC_QUAR_12==4]<-3
AYA$income<-factor(AYA$income, levels=c(0:3), labels=c("Less than $38,000", "$38,000-$47,999", "$48,000-$62,999", "$63,000+"))
table(AYA$income, useNA="always")

#Rural/Urban
AYA$RUCC[AYA$UR_CD_13==1]<-0
AYA$RUCC[AYA$UR_CD_13==2]<-1
AYA$RUCC[AYA$UR_CD_13==3]<-2
AYA$RUCC[AYA$UR_CD_13==4]<-3
AYA$RUCC[AYA$UR_CD_13==5]<-4
AYA$RUCC[AYA$UR_CD_13==6]<-5
AYA$RUCC[AYA$UR_CD_13==7]<-6
AYA$RUCC[AYA$UR_CD_13==8]<-7
AYA$RUCC[AYA$UR_CD_13==9]<-8
AYA$RUCC<-factor(AYA$RUCC, levels=c(0:8), labels=c("Counties in metro areas of ≥ 1 million", "Counties in metro areas of 250,000 to 1 million", "Counties in metro areas of <250,000", "Urban population of ≥20,000, adjacent to a metro area", "Urban population of ≥20,000, not adjacent to a metro area", "Urban population of 2,500 to 19,999, adjacent to a metro area", "Urban population of 2,500 to 19,999, not adjacent to a metro area", "Completely rural or ≤2,500 urban population, adjacent to a metro area", "Completely rural or ≤2,500 urban population, not adjacent to a metro area"))
table(AYA$RUCC, useNA="always") #no missing data

#divide into metro, nonmetrourban, and rural
AYA$RUCC3[AYA$RUCC=="Counties in metro areas of ≥ 1 million"|AYA$RUCC=="Counties in metro areas of 250,000 to 1 million"|AYA$RUCC=="Counties in metro areas of <250,000"]<-0

AYA$RUCC3[AYA$RUCC=="Urban population of ≥20,000, adjacent to a metro area"|AYA$RUCC=="Urban population of ≥20,000, not adjacent to a metro area"|AYA$RUCC=="Urban population of 2,500 to 19,999, adjacent to a metro area"|AYA$RUCC=="Urban population of 2,500 to 19,999, not adjacent to a metro area"]<-1

AYA$RUCC3[AYA$RUCC=="Completely rural or ≤2,500 urban population, adjacent to a metro area"|AYA$RUCC=="Completely rural or ≤2,500 urban population, not adjacent to a metro area"]<-2
AYA$RUCC3<-factor(AYA$RUCC3, levels=c(0:2), labels=c("Metro", "Non-metro Urban", "Rural"))

table(AYA$RUCC3, AYA$RUCC, useNA="ifany")
table(AYA$RUCC3, useNA="ifany")

#greater circle distance
#Justifcation from PMID: 24516014  "Three patient groups were created on the basis of travel distance: short ( 12.5 miles); intermediate (12.5 to 49.9 miles); long ( 50 miles). We selected 50 miles as our long-distance benchmark on the basis of work by Onega et al.9"
AYA$GCD[AYA$CROWFLY<=12.5]<-0
AYA$GCD[AYA$CROWFLY>12.5 & AYA$CROWFLY<=49.9]<-1
AYA$GCD[AYA$CROWFLY>=50]<-2
AYA$GCD<-factor(AYA$GCD, levels=c(0:2), labels=c("Short", "Intermediate", "Long"))
table(AYA$GCD)

#recode vital status
AYA$dead[AYA$PUF_VITAL_STATUS==1]<-0
AYA$dead[AYA$PUF_VITAL_STATUS==0]<-1
table(AYA$dead)

#person months
summary(AYA$DX_LASTCONTACT_DEATH_MONTHS)

#cancer type coding according to https://seer.cancer.gov/ayarecode/aya-who2008.html
AYA$cantype[(AYA$PRIMARY_SITE %in% c(0:809)& AYA$HISTOLOGY%in%c(9826, 9835:9836,9840, 9861, 9865:9867, 9869, 9871:9874, 9891, 9895:9898, 9910:9911, 9920,9863, 9875:9876, 9945:9946,9742, 9800:9801, 9805:9809, 9820, 9831:9834, 9860, 9870, 9930:9931, 9940, 9948, 9963:9964))|
(AYA$PRIMARY_SITE %in% c(420:421, 424)& AYA$HISTOLOGY%in%c(9811:9818, 9837))|
(AYA$PRIMARY_SITE %in% c(420:421, 424)& AYA$HISTOLOGY%in%c(9823, 9827))]<-
"1.0 Leukemias"

AYA$cantype[(AYA$PRIMARY_SITE %in% c(0:809)& AYA$HISTOLOGY%in%c(9590:9591, 9596:9597, 9670:9671, 9673, 9675, 9678:9680, 9684, 9687:9691, 9695, 9698:9702, 9705, 9708:9709, 9712, 9714, 9716:9719, 9725:9729, 9735, 9737:9738, 9650:9655, 9659, 9661:9665, 9667))|
(AYA$PRIMARY_SITE %in% c(0:419, 422:423, 425:809)& AYA$HISTOLOGY%in%c( 9811:9818, 9823, 9827, 9837))]<-
"2.1 Non-Hodgkin lymphoma"

AYA$cantype[AYA$PRIMARY_SITE %in% c(0:809)& AYA$HISTOLOGY%in%c(9650:9655, 9659, 9661:9665, 9667)]<-
"2.2 Hodgkin lymphoma"

AYA$cantype[(AYA$PRIMARY_SITE %in% c(0:809)& AYA$HISTOLOGY%in%c(9410:9411, 9420:9421, 9424,9401, 9440:9442, 9400, 9381:9384, 9423, 9430, 9450:9451, 9460,	9391:9394))|
(AYA$PRIMARY_SITE %in% c(723)& AYA$HISTOLOGY %in% c(9380))|
(AYA$PRIMARY_SITE %in% c(0:722, 724:809) & AYA$HISTOLOGY %in% c(9380))|
  
(AYA$PRIMARY_SITE %in% c(716) & AYA$HISTOLOGY %in% c(9470:9474))|
(AYA$PRIMARY_SITE %in% c(0:715, 717:809) & AYA$HISTOLOGY %in% c(9470:9474))|
(AYA$PRIMARY_SITE %in% c(0:699, 730:750, 754:809) & AYA$HISTOLOGY %in% c(9350:9351, 9360:9362, 9390, 9480, 9530:9535, 9537:9539, 9541, 9550, 9562, 9570))|
(AYA$PRIMARY_SITE %in% c(700:729, 751:753) & AYA$HISTOLOGY %in% c(9161, 9361:9362, 9390, 9530:9531, 9535, 9538, 9540, 9560, 9571))|
(AYA$PRIMARY_SITE %in% c(700) & AYA$HISTOLOGY %in% c(9532, 9534, 9537, 9539))|
(AYA$PRIMARY_SITE %in% c(753) & AYA$HISTOLOGY %in% c(9360))|
(AYA$PRIMARY_SITE %in% c(711) & AYA$HISTOLOGY %in% c(9480, 9539))|
(AYA$PRIMARY_SITE %in% c(713) & AYA$HISTOLOGY %in% c(9480, 9533))|
(AYA$PRIMARY_SITE %in% c(719) & AYA$HISTOLOGY %in% c(9350))|
(AYA$PRIMARY_SITE %in% c(714,717) & AYA$HISTOLOGY %in% c(9480))|
(AYA$PRIMARY_SITE %in% c(709) & AYA$HISTOLOGY %in% c(9539))|
(AYA$PRIMARY_SITE %in% c(700:729, 751:753) & AYA$HISTOLOGY %in% c(8000:8005))]<-
"3.0 CNS and Other Intracranial and Intraspinal Neoplasms (all behaviors)"

AYA$cantype[(AYA$PRIMARY_SITE %in% c(569, 620:629)& AYA$HISTOLOGY%in%c(9060:9065, 9070:9073, 9080:9085, 9090:9091, 9100:9102, 9105) & AYA$BEHAVIOR==3)|
(AYA$PRIMARY_SITE %in% c(700:729, 751:753)& AYA$HISTOLOGY%in%c(9060:9065, 9070:9073, 9080:9085, 9090:9091, 9100:9102, 9105) & AYA$BEHAVIOR %in% c(0,1,3))|
(AYA$PRIMARY_SITE %in% c(0:568, 570:619, 630:699, 730:750, 754:809)& AYA$HISTOLOGY %in%  c(9060:9065, 9070:9073, 9080:9085, 9090:9091, 9100:9102, 9104:9105) & AYA$BEHAVIOR==3)]<-
"6.1 Germ cell and trophoblastic neoplasms of gonads"

AYA$cantype[AYA$PRIMARY_SITE %in% c(0:809) & AYA$HISTOLOGY %in% c(8720:8723, 8726, 8728, 8730, 8740:8746, 8761, 8770:8774, 8780) & AYA$BEHAVIOR==3]<-
"7.1 Melanoma"

AYA$cantype[AYA$PRIMARY_SITE %in% c(739)&AYA$HISTOLOGY%in%c(8010:8589) & AYA$BEHAVIOR==3]<-
"8.1 Thyroid carcinoma"

AYA$cantype[(AYA$PRIMARY_SITE %in% c(110:119) & AYA$HISTOLOGY %in% c(8010:8589) & AYA$BEHAVIOR==3)|
(AYA$PRIMARY_SITE %in% c(0:109, 120:148) & AYA$HISTOLOGY %in% c(8010:8589) & AYA$BEHAVIOR==3)|
 (AYA$PRIMARY_SITE %in% c(300:329,760) & AYA$HISTOLOGY %in% c(8010:8589) & AYA$BEHAVIOR==3)]<-
"8.2 Carcinoma of head and neck"

AYA$cantype[AYA$PRIMARY_SITE %in% c(330:349) &  AYA$HISTOLOGY %in% c(8010:8589) & AYA$BEHAVIOR==3]<-
"8.3 Carcinoma of trachea, bronchus, and lung"

AYA$cantype[AYA$PRIMARY_SITE %in% c(500:509) & AYA$HISTOLOGY %in% c(8010:8589) & AYA$BEHAVIOR==3]<-
"8.4 Carcinoma of breast"

AYA$cantype[AYA$PRIMARY_SITE %in% c(649)&AYA$HISTOLOGY %in% c(8010:8589) & AYA$BEHAVIOR==3]<-
"8.5.1 Carcinoma of kidney"

AYA$cantype[AYA$PRIMARY_SITE %in% c(530, 531, 538,539)&AYA$HISTOLOGY%in%c(8010:8589)]<-
"8.5.4 Carcinoma of cervix"

AYA$cantype[AYA$PRIMARY_SITE %in% c(180:218)&AYA$HISTOLOGY %in% c(8010:8589) & AYA$BEHAVIOR==3]<-
"8.6.1 Carcinoma of colon and rectum"

AYA$cantype[AYA$PRIMARY_SITE %in% c(160:169)&AYA$HISTOLOGY %in% c(8010:8589) & AYA$BEHAVIOR==3]<-
"8.6.2 Carcinoma of stomach"

AYA$cantype[(AYA$PRIMARY_SITE %in% c(569, 620:629) & AYA$HISTOLOGY %in% c(8010:8589) & AYA$BEHAVIOR==3)|
(AYA$PRIMARY_SITE %in% c(0:809) & AYA$HISTOLOGY %in% c(8590:8593) & AYA$BEHAVIOR==3)]<-
"8.5.3 Carcinoma of gonads"

AYA$cantype[(AYA$PRIMARY_SITE %in% c(0:809)&AYA$HISTOLOGY%in%c(9180:9187, 9192:9194,9220:9221, 9230:9231, 9240, 9242:9243, 9260, 9364:9365, 8812, 9250, 9261, 9370:9372))|
(AYA$PRIMARY_SITE %in% c(400:419)& AYA$HISTOLOGY%in% c(8000:8005, 8800:8803, 8805:8806, 9200))]<-
"4.0 Osseous and chondromatous neoplasms"

AYA$cantype[(AYA$PRIMARY_SITE %in% c(0:809) &  AYA$HISTOLOGY %in% c(8810:8811, 8813:8815, 8820:8824, 8830, 8832:8833, 8835:8836, 9252, 8900:8904, 8910, 8912, 8920:8921, 8991,8804, 8825, 8840:8897, 8982:8983, 8990, 9040:9044, 9120:9139, 9141:9150, 9170, 9251, 9561, 9580:9581) & AYA$BEHAVIOR==3)|
(AYA$PRIMARY_SITE %in% c(0:699, 730:750, 754:809) & AYA$HISTOLOGY %in%c (9540, 9560, 9571) & AYA$BEHAVIOR==3)|
(AYA$PRIMARY_SITE %in% c(0:809) & AYA$HISTOLOGY %in% c(9140) & AYA$BEHAVIOR==3)|
(AYA$PRIMARY_SITE %in% c(0:399, 420:809) & AYA$HISTOLOGY %in% c(8800:8803, 8805:8806) & AYA$BEHAVIOR==3)]<-
"5.0 Soft Tissue Sarcomas"

table1(~cantype, droplevels=TRUE, data=AYA)

#Apply variable labels
AYA<-apply_labels(AYA, insurance="Insurance", Age_cat="Age category", SEX="Sex", RACE="Race", educ="Education", income="Income", stage="Stage at diagnosis", cantype="Cancer Type")

table(AYA$cantype, AYA$Cancer.Type.Justin.Recode)

```

# Exclusions
```{r}
#exclude individuals <15 and with years of dx outside of 2010-2014
AYA2<-AYA[which(AYA$AGE >=15 & AYA$YEAR_OF_DIAGNOSIS>=2010 & AYA$YEAR_OF_DIAGNOSIS<=2014),]

#exclude individuals seen at more that one facility
AYA2<-AYA2[which(AYA2$PUF_MULT_SOURCE==0),]

#Code to determine facility exclusions and exclude facilities that didn't report all years
tab<-table(AYA2$PUF_FACILITY_ID, AYA2$YEAR_OF_DIAGNOSIS)
tab2<-as.data.frame.matrix(tab)
colnames(tab2)<-c("yr10","yr11", "yr12", "yr13", "yr14") #R doesn't like numerical column names
tab2<-cbind(facility=rownames(tab2), tab2) #turn rows into a column (one column)
rownames(tab2)<-NULL #remove row names from first 'column'

#Code to exclude facilities not reporting all years
tab3<-subset(tab2, yr10==0|yr11==0|yr12==0|yr13==0|yr14==0)
facility<-as.vector(tab3$facility)
facility
typeof(facility)
#remove anyone with a facility vector value 
exclude<-AYA2[!(AYA2$PUF_FACILITY_ID%in%facility),]

#Exclude second cancers and those with cancer types recorded as other
exclude<-exclude[which(exclude$SEQUENCE_NUMBER==0),] 
exclude<-exclude[which(!is.na(exclude$cantype)),] #use for leukemia and brain below'

#Exclude leukemias and brain that are not staged 
exclude2<- subset(exclude, cantype!="1.0 Leukemias" & cantype!="3.0 CNS and Other Intracranial and Intraspinal Neoplasms (all behaviors)")

table(exclude2$ANALYTIC_STAGE_GROUP)

#Exclude "Stage 0", "Occult (lung only)", "AJCC Staging Not Applicable"
analytic_dt<-subset(exclude2, ANALYTIC_STAGE_GROUP !=0 & ANALYTIC_STAGE_GROUP !=5 & ANALYTIC_STAGE_GROUP !=8)

```

#Second set of exclusions of missing data for complete dataset
```{r}
#Remove missing values from dataset for stage analysis
analytic_dt_v <- analytic_dt[which(analytic_dt$RACE!="NA"),]
analytic_dt_v <- analytic_dt_v[which(analytic_dt_v$insurance!="NA"),]
analytic_dt_v <- analytic_dt_v[which(analytic_dt_v$stage_binary!="NA"),]
analytic_dt_v <- analytic_dt_v[which(analytic_dt_v$educ!="NA"),]
analytic_dt_v <- analytic_dt_v[which(analytic_dt_v$income!="NA"),]
analytic_dt_v <- analytic_dt_v[which(analytic_dt_v$RUCC!="NA"),]
analytic_dt_v <- analytic_dt_v[which(analytic_dt_v$RUCC3!="NA"),]
analytic_dt_v <- analytic_dt_v[which(analytic_dt_v$GCD!="NA"),]
analytic_dt_v <- analytic_dt_v[which(analytic_dt_v$dead!="NA"),]
analytic_dt_v <- analytic_dt_v[which(analytic_dt_v$DX_LASTCONTACT_DEATH_MONTHS!="NA"),]

#exclude for leukemia and brain for vital status analysis
analytic_dt_lb <- exclude[which(exclude$RACE!="NA"),]
analytic_dt_lb <- analytic_dt_lb[which(analytic_dt_lb$insurance!="NA"),]
analytic_dt_lb <- analytic_dt_lb[which(analytic_dt_lb$educ!="NA"),]
analytic_dt_lb <- analytic_dt_lb[which(analytic_dt_lb$income!="NA"),]
analytic_dt_lb <- analytic_dt_lb[which(analytic_dt_lb$RUCC!="NA"),]
analytic_dt_lb <- analytic_dt_lb[which(analytic_dt_lb$RUCC3!="NA"),]
analytic_dt_lb <- analytic_dt_lb[which(analytic_dt_lb$GCD!="NA"),]
analytic_dt_lb <- analytic_dt_lb[which(analytic_dt_lb$dead!="NA"),]
analytic_dt_lb <- analytic_dt_lb[which(analytic_dt_lb$DX_LASTCONTACT_DEATH_MONTHS!="NA"),]

```

# Figure 1: flowchart for stage
```{r}
#install.packages("DiagrammeR")
library(DiagrammeR)
pdf(file = "Figure 1.pdf")
grViz("digraph flowchart {

      # node definitions with substituted label text
      node [fontname = Helvetica, shape = rectangle, fontsize=10]        
      tab1 [label = '@@1']
      tab2 [label = '@@2']
      tab3 [label = '@@3']
      tab4 [label = '@@4']
      tab5 [label = '@@5']
      tab6 [label = '@@6']
      tab7 [label = '@@7']
      tab8 [label = '@@8']
      tab9 [label = '@@9']
      # edge definitions with the node IDs
      tab1 -> tab2 -> tab3 -> tab4 -> tab5;
      tab5 -> tab6 -> tab7 -> tab8;
      tab5 -> tab9;
      }
      [1]: 'Records received from NCDB for diagnoses in 0-39 2004-2015 n=780,847'
      [2]: 'Excluding 471,307 individuals diagnosed before age 15 and before 2010 n=309,540'
      [3]: 'Excluding 45,0101 individuals seen at more than one facility n=263,530'
      [4]: 'Excluding 6022 facilities not reporting in all years n=257,508'
      [5]: 'Excluding 65,500 individuals with second cancers and \\n those with cancer types not included in analysis n=192,008'
      [6]: 'Excluding 19,825 individuals with leukemia and \\n  brain tumors n=172,183'
      [7]: 'Excluding 5400 individuals not malignant, stage 0, \\n Occult (lung only), and AJCC staging not applicable n=166,783'
      [8]: 'Excluding 20,365 individuals with missing data \\n on variables used in the stage analysis n=146,418'
      [9]: 'Excluding 14,137 individuals with missing data on variables \\n used in the survival analysis n=178,688'
      ")

dev.off()
```
#Check cancer type classification
```{r}
table1(~cantype + Cancer.Type.Justin.Recode,  analytic_dt_lb) #differences in STS are due to KS (n=1080), differences in breast are due to male breast (n=148), differences in GCTs are due to non-gonadal tumors (n=1250))
```

#Check association between rural/urban and GCD variables
```{r}
table(analytic_dt_v$RUCC, analytic_dt_v$GCD)
chisq.test(table(analytic_dt_v$RUCC, analytic_dt_v$GCD))
table1(~RUCC|GCD,analytic_dt_v)
```

#Table 1: Descriptive characteristics for stage dataset
```{r}

analytic_dt_v$stage<-droplevels(analytic_dt_v$stage)
label(analytic_dt_v$stage)<-"Stage at diagnosis"
label(analytic_dt_v$stage_binary)<-"Stage at diagnosis (early vs. late)"
label(analytic_dt_v$insurance)<-"Insurance at diagnosis or first treatment"
label(analytic_dt_v$educ)<-"Zip-code median percent no high school degree quartile 2008-2012"
label(analytic_dt_v$income)<-"Zip-code median income quartile 2008-2012"

table1(~SEX + Age_cat + RACE + insurance + income + educ + stage + stage_binary + cantype |RUCC3, rowlabelhead="Variable", droplevels=TRUE, data=analytic_dt_v)

```
#Supplementary Table 1: Descriptive characteristics for overall survival dataset
```{r}
analytic_dt_lb$stage<-droplevels(analytic_dt_lb$stage)
label(analytic_dt_lb$stage)<-"Stage at diagnosis"
label(analytic_dt_lb$stage_binary)<-"Stage at diagnosis (early vs. late)"
label(analytic_dt_lb$insurance)<-"Insurance at diagnosis or first treatment"
label(analytic_dt_lb$educ)<-"Zip-code median percent no high school degree quartile 2008-2012"
label(analytic_dt_lb$income)<-"Zip-code median income quartile 2008-2012"
table1(~SEX + Age_cat + RACE + insurance  + income + educ + + stage + stage_binary + cantype|RUCC3, droplevels=TRUE, data=analytic_dt_lb)

```

#Table 2: Unadjusted regression models for stage (Rural Urban distance)
```{r}
#RUCC 9 category
model1<-glm(stage_binary ~ RUCC, family = "binomial", data = analytic_dt_v)
summary(model1)

odds.n.ends(model1)
nobs(model1)
addmargins(table(analytic_dt_v$stage_binary, analytic_dt_v$RUCC))

#RUCC 3 category
model2<-glm(stage_binary ~ RUCC3, family = "binomial", data = analytic_dt_v)
summary(model2)

odds.n.ends(model2)
nobs(model2)
addmargins(table(analytic_dt_v$stage_binary, analytic_dt_v$RUCC3))

#Crowflys
model_GCD<-glm(stage_binary ~ GCD, family = "binomial", data = analytic_dt_v)
summary(model_GCD)

odds.n.ends(model_GCD)
nobs(model_GCD)
addmargins(table(analytic_dt_v$stage_binary, analytic_dt_v$GCD))
```

#Table 2: Adjusted regression models for stage (Rural Urban distance)
```{r}
#Adjusted for confounders determined from DAG (minimal set-race, education, age, sex)
model1a<-glm(stage_binary ~ RUCC + RACE + AGE + SEX +educ, family = "binomial", data = analytic_dt_v)

odds.n.ends(model1a)
nobs(model1a)

#Adjusted for confounders determined from DAG (minimal set-race, education, age, sex) 
model2a<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt_v)

odds.n.ends(model2a)
nobs(model2a)

#Adjusted for confounders determined from DAG (minimal set-race, education, age, sex)
model_GCDa<-glm(stage_binary ~ GCD + RACE + AGE + educ+ SEX, family = "binomial", data = analytic_dt_v)

odds.n.ends(model_GCDa)
nobs(model_GCDa)

#Adjusted for confounders determined from DAG (minimal set-race, education, age, sex + RUCC3)
model_GCDa<-glm(stage_binary ~ GCD + RACE + AGE + educ+ SEX +RUCC3, family = "binomial", data = analytic_dt_v)

odds.n.ends(model_GCDa)
nobs(model_GCDa)
```

# Modification by sex, race, and cancer type of associations between RUCC3 and GCD and stage binary
```{r}
# Effect modification by sex RUCC3
modelsex<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt_v)
summary(modelsex)

modelsexint<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ  + RUCC3*SEX, family = "binomial", data = analytic_dt_v)
summary(modelsex)

lrtestEM<-lrtest(modelsex, modelsexint)
lrtestEM #no interaction by SEX

# Effect modification by RACE RUCC3
modelRACE<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt_v)
summary(modelRACE)

modelRACEint<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ  + RUCC3*RACE, family = "binomial", data = analytic_dt_v)
summary(modelRACEint)

lrtestEM<-lrtest(modelRACE, modelRACEint)
lrtestEM #no interaction by RACE

# Effect modification by cancer type RUCC3
modelcantype<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ + cantype, family = "binomial", data = analytic_dt_v)
summary(modelcantype)

modelcantypeint<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ  + cantype + RUCC3*cantype, family = "binomial", data = analytic_dt_v)
summary(modelcantypeint)

lrtestEM<-lrtest(modelcantype, modelcantypeint)
lrtestEM

# Effect modification by sex GCD
modelsex<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt_v)
summary(modelsex)

modelsexint<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ  + GCD*SEX, family = "binomial", data = analytic_dt_v)
summary(modelsex)

lrtestEM<-lrtest(modelsex, modelsexint)
lrtestEM #interaction by SEX 0.01

# How different are the estimates?
modelsex<-glm(stage_binary ~ GCD + RACE + AGE + educ, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$SEX=="Male"),])
summary(modelsex)
odds.n.ends(modelsex) #males

modelsex<-glm(stage_binary ~ GCD + RACE + AGE + educ, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$SEX=="Female"),])
summary(modelsex)
odds.n.ends(modelsex) #females

# Effect modification by RACE GCD
modelRACE<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt_v)
summary(modelsex)

modelRACEint<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ  + GCD*RACE, family = "binomial", data = analytic_dt_v)
summary(modelsex)

lrtestEM<-lrtest(modelRACE, modelRACEint)
lrtestEM #no interaction by RACE (p>0.05)

# How different are the estimates?
modelRACE<-glm(stage_binary ~ GCD + SEX + AGE + educ, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$RACE=="Non-Hispanic White"),])
summary(modelRACE)
odds.n.ends(modelRACE) #White

modelRACE<-glm(stage_binary ~ GCD + SEX + AGE + educ, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$RACE=="Non-Hispanic Black"),])
summary(modelRACE)
odds.n.ends(modelRACE) #Black

modelRACE<-glm(stage_binary ~ GCD + SEX + AGE + educ, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$RACE=="Hispanic"),])
summary(modelRACE)
odds.n.ends(modelRACE) #Hispanic

modelRACE<-glm(stage_binary ~ GCD + SEX + AGE + educ, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$RACE=="Non-Hispanic Other"),])
summary(modelRACE)
odds.n.ends(modelRACE) #Non-Hispanic Other

# Effect modification by cancer type GCD
modelcantype<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ + cantype, family = "binomial", data = analytic_dt_v)

modelcantypeint<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ + cantype + GCD*cantype, family = "binomial", data = analytic_dt_v)

lrtestEM<-lrtest(modelcantype, modelcantypeint)
lrtestEM
```

# OR by cancer types by RUCC3 and GCD
```{r}
# 2.1 Non-Hodgkin lymphoma
model5a<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="2.1 Non-Hodgkin lymphoma"),])
summary(model5a)

ORmodel5a<-exp(cbind(OR = coef(model5a), confint(model5a))) #calculate ORs and 95% CIs
  ORmodel5a #print ORs and 95% CIs

#GCD
model5b<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="2.1 Non-Hodgkin lymphoma"),])
summary(model5b)

ORmodel5b<-exp(cbind(OR = coef(model5b), confint(model5b))) #calculate ORs and 95% CIs
  ORmodel5b #print ORs and 95% CIs

#**********************************************
#2.2 Hodgkin lymphoma
model5<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="2.2 Hodgkin lymphoma"),])

ORmodel5<-exp(cbind(OR = coef(model5), confint(model5))) #calculate ORs and 95% CIs
  ORmodel5 #print ORs and 95% CIs
  
#GCD
model5c<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="2.2 Hodgkin lymphoma"),])

ORmodel5c<-exp(cbind(OR = coef(model5c), confint(model5c))) #calculate ORs and 95% CIs
  ORmodel5c #print ORs and 95% CIs
#**********************************************
#4.0 Osseous and chondromatous neoplasms
model6<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="4.0 Osseous and chondromatous neoplasms"),])

ORmodel6<-exp(cbind(OR = coef(model6), confint(model6))) #calculate ORs and 95% CIs
  ORmodel6 #print ORs and 95% CIs
  
#GCD
model6a<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="4.0 Osseous and chondromatous neoplasms"),])
summary(model6a)

ORmodel6a<-exp(cbind(OR = coef(model6a), confint(model6a))) #calculate ORs and 95% CIs
  ORmodel6a #print ORs and 95% CIs

#**********************************************
#5.0 Soft Tissue Sarcomas 
model7<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="5.0 Soft Tissue Sarcomas"),])
summary(model7)

ORmodel7<-exp(cbind(OR = coef(model7), confint(model7))) #calculate ORs and 95% CIs
  ORmodel7 #print ORs and 95% CIs
  
#GCD
model7a<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="5.0 Soft Tissue Sarcomas"),])
summary(model7a)

ORmodel7a<-exp(cbind(OR = coef(model7a), confint(model7a))) #calculate ORs and 95% CIs
  ORmodel7a #print ORs and 95% CIs

#**********************************************
#6.1 Germ cell and trophoblastic neoplasms of gonads
model8<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="6.1 Germ cell and trophoblastic neoplasms of gonads"),])
summary(model8)


ORmodel8<-exp(cbind(OR = coef(model8), confint(model8))) #calculate ORs and 95% CIs
  ORmodel8 #print ORs and 95% CIs
  
#GCD
model8a<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="6.1 Germ cell and trophoblastic neoplasms of gonads"),])
summary(model8a)

ORmodel8a<-exp(cbind(OR = coef(model8a), confint(model8a))) #calculate ORs and 95% CIs
  ORmodel8a #print ORs and 95% CIs

#**********************************************
#7.1 Melanoma
model9<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="7.1 Melanoma"),])
summary(model9)

ORmodel9<-exp(cbind(OR = coef(model9), confint(model9))) #calculate ORs and 95% CIs
  ORmodel9 #print ORs and 95% CIs
  
#GCD
model9a<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="7.1 Melanoma"),])
summary(model9a)

ORmodel9a<-exp(cbind(OR = coef(model9a), confint(model9a))) #calculate ORs and 95% CIs
  ORmodel9a #print ORs and 95% CIs

#**********************************************
#8.1 Thyroid carcinoma
model10<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="8.1 Thyroid carcinoma"),])
summary(model10)

ORmodel10<-exp(cbind(OR = coef(model10), confint(model10))) #calculate ORs and 95% CIs
  ORmodel10 #print ORs and 95% CIs
  
#GCD
model10a<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="8.1 Thyroid carcinoma"),])
summary(model10a)

ORmodel10a<-exp(cbind(OR = coef(model10a), confint(model10a))) #calculate ORs and 95% CIs
  ORmodel10a #print ORs and 95% CIs

#**********************************************
#8.2 Carcinoma of head and neck
model11<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="8.2 Carcinoma of head and neck"),])
summary(model11)


ORmodel11<-exp(cbind(OR = coef(model11), confint(model11))) #calculate ORs and 95% CIs
  ORmodel11 #print ORs and 95% CIs

#GCD
model11a<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="8.2 Carcinoma of head and neck"),])
summary(model11a)

ORmodel11a<-exp(cbind(OR = coef(model11a), confint(model11a))) #calculate ORs and 95% CIs
  ORmodel11a #print ORs and 95% CIs

#**********************************************
#8.3 Carcinoma of trachea,bronchus, and lung
model12<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="8.3 Carcinoma of trachea, bronchus, and lung"),])
summary(model12)

ORmodel12<-exp(cbind(OR = coef(model12), confint(model12))) #calculate ORs and 95% CIs
  ORmodel12 #print ORs and 95% CIs
  
#GCD
model12a<-glm(stage_binary ~ GCD+ RACE + AGE + SEX + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="8.3 Carcinoma of trachea, bronchus, and lung"),])
summary(model12a)


ORmodel12a<-exp(cbind(OR = coef(model12a), confint(model12a))) #calculate ORs and 95% CIs
  ORmodel12a #print ORs and 95% CIs

#**********************************************
#8.4 Carcinoma of breast=
model13<-glm(stage_binary ~ RUCC3 + RACE + AGE  + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="8.4 Carcinoma of breast"),])
summary(model13)

ORmodel13<-exp(cbind(OR = coef(model13), confint(model13))) #calculate ORs and 95% CIs
  ORmodel13 #print ORs and 95% CIs
  
#GCD
model13a<-glm(stage_binary ~ GCD + RACE + AGE  + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="8.4 Carcinoma of breast"),])
summary(model13a)

ORmodel13a<-exp(cbind(OR = coef(model13a), confint(model13a))) #calculate ORs and 95% CIs
  ORmodel13a #print ORs and 95% CIs

#**********************************************
#8.5.1 Carcinoma of kidney
model14<-glm(stage_binary ~ RUCC3 + RACE + AGE  + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="8.5.1 Carcinoma of kidney"),])
summary(model14)

ORmodel14<-exp(cbind(OR = coef(model14), confint(model14))) #calculate ORs and 95% CIs
  ORmodel14 #print ORs and 95% CIs
  
#GCD
model14a<-glm(stage_binary ~ GCD + RACE + AGE  + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="8.5.1 Carcinoma of kidney"),])
summary(model14a)

ORmodel14a<-exp(cbind(OR = coef(model14a), confint(model14a))) #calculate ORs and 95% CIs
  ORmodel14a #print ORs and 95% CIs

#**********************************************
#8.5.3 Carcinoma of gonads
model15<-glm(stage_binary ~ RUCC3 + RACE + SEX + AGE  + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="8.5.3 Carcinoma of gonads"),])
summary(model15)

ORmodel15<-exp(cbind(OR = coef(model15), confint(model15))) #calculate ORs and 95% CIs
  ORmodel15 #print ORs and 95% CIs
  
#GCD
model15a<-glm(stage_binary ~ GCD + RACE + SEX + AGE  + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="8.5.3 Carcinoma of gonads"),])
summary(model15a)

ORmodel15a<-exp(cbind(OR = coef(model15a), confint(model15a))) #calculate ORs and 95% CIs
  ORmodel15a #print ORs and 95% CIs

#**********************************************
#8.5.4 Carcinoma of cervix
model16<-glm(stage_binary ~ RUCC3 + RACE +AGE  + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="8.5.4 Carcinoma of cervix"),])
summary(model16)

ORmodel16<-exp(cbind(OR = coef(model16), confint(model16))) #calculate ORs and 95% CIs
  ORmodel16 #print ORs and 95% CIs
  
#GCD
model16a<-glm(stage_binary ~ GCD + RACE +AGE  + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="8.5.4 Carcinoma of cervix"),])
summary(model16a)

ORmodel16a<-exp(cbind(OR = coef(model16a), confint(model16a))) #calculate ORs and 95% CIs
  ORmodel16a #print ORs and 95% CIs

#**********************************************
#8.6.1 Carcinoma of colon and rectum
model17<-glm(stage_binary ~ RUCC3 + RACE + SEX+ AGE + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="8.6.1 Carcinoma of colon and rectum"),])
summary(model17)
ORmodel17<-exp(cbind(OR = coef(model17), confint(model17))) #calculate ORs and 95% CIs
  ORmodel17 #print ORs and 95% CIs

#GCD
model17a<-glm(stage_binary ~ GCD + RACE + SEX+ AGE + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="8.6.1 Carcinoma of colon and rectum"),])
summary(model17a)

ORmodel17a<-exp(cbind(OR = coef(model17a), confint(model17a))) #calculate ORs and 95% CIs
  ORmodel17a #print ORs and 95% CIs

#**********************************************
#8.6.2 Carcinoma of stomach
model18<-glm(stage_binary ~ RUCC3 + RACE + SEX+ AGE + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="8.6.2 Carcinoma of stomach"),])
summary(model18)

ORmodel18<-exp(cbind(OR = coef(model18), confint(model18))) #calculate ORs and 95% CIs
  ORmodel18 #print ORs and 95% CIs
  
#GCD
model18a<-glm(stage_binary ~ GCD + RACE + SEX+ AGE + educ, family = "binomial", data = analytic_dt[which(analytic_dt$cantype=="8.6.2 Carcinoma of stomach"),])
summary(model18a)

 ORmodel18a<-exp(cbind(OR = coef(model18a), confint(model18a))) #calculate ORs and 95% CIs
  ORmodel18a #print ORs and 95% CIs
```
# Graph ORs and 95% CIs for cancer types for RUC (not used)
```{r}
#make empty data frame
etable2<-data.frame(matrix(ncol=5, nrow=0))
columns<-c("Cancer_type", "RUC", "OR", "lowCI", "UpperCI")
colnames(etable2)<-columns

etable2[1,]<-c('NHL',  'Rural', format(ORmodel5a[3,1], digits=3), format(ORmodel5a[3,2], digits=3), format(ORmodel5a[3,3], digits=3))
etable2[2,]<-c('NHL',  'Non-metro Urban', format(ORmodel5a[2,1], digits=3), format(ORmodel5a[2,2], digits=3), format(ORmodel5a[2,3], digits=3))
etable2[3,]<-c('HL',  'Rural', format(ORmodel5[3,1],digits=3), format(ORmodel5[3,2], digits=3), format(ORmodel5[3,3], digits=3))
etable2[4,]<-c('HL',  'Non-metro Urban', format(ORmodel5[2,1],digits=3), format(ORmodel5[2,2], digits=3), format(ORmodel5[2,3], digits=3))
etable2[5,]<-c('OS',  'Rural', format(ORmodel6[3,1],digits=3), format(ORmodel6[3,2],digits=3), format(ORmodel6[3,3], digits=3))
etable2[6,]<-c('OS',  'Non-metro Urban', format(ORmodel6[2,1],digits=3), format(ORmodel6[2,2],digits=3), format(ORmodel6[2,3],digits=3))
etable2[7,]<-c('STS',  'Rural', format(ORmodel7[3,1],digits=3), format(ORmodel7[3,2],digits=3), format(ORmodel7[3,3], digits=3))
etable2[8,]<-c('STS',  'Non-metro Urban', format(ORmodel7[2,1],digits=3), format(ORmodel7[2,2],digits=3), format(ORmodel7[2,3],digits=3))
etable2[9,]<-c('GCT',  'Rural', format(ORmodel8[3,1],digits=3), format(ORmodel8[3,2],digits=3), format(ORmodel8[3,3], digits=3))
etable2[10,]<-c('GCT',  'Non-metro Urban', format(ORmodel8[2,1],digits=3), format(ORmodel8[2,2],digits=3), format(ORmodel8[2,3],digits=3))
etable2[11,]<-c('MEL',  'Rural', format(ORmodel9[3,1],digits=3), format(ORmodel9[3,2],digits=3), format(ORmodel9[3,3], digits=3))
etable2[12,]<-c('MEL',  'Non-metro Urban', format(ORmodel9[2,1],digits=3), format(ORmodel9[2,2],digits=3), format(ORmodel9[2,3],digits=3))
etable2[13,]<-c('THY',  'Rural', format(ORmodel10[3,1],digits=3), format(ORmodel10[3,2],digits=3), format(ORmodel10[3,3], digits=3))
etable2[14,]<-c('THY',  'Non-metro Urban', format(ORmodel10[2,1],digits=3), format(ORmodel10[2,2],digits=3), format(ORmodel10[2,3],digits=3))
etable2[15,]<-c('HN',  'Rural', format(ORmodel11[3,1],digits=3), format(ORmodel11[3,2],digits=3), format(ORmodel11[3,3], digits=3))
etable2[16,]<-c('HN',  'Non-metro Urban', format(ORmodel11[2,1],digits=3), format(ORmodel11[2,2],digits=3), format(ORmodel11[2,3],digits=3))
etable2[17,]<-c('LUNG',  'Rural', format(ORmodel12[3,1],digits=3), format(ORmodel12[3,2],digits=3), format(ORmodel12[3,3], digits=3))
etable2[18,]<-c('LUNG',  'Non-metro Urban', format(ORmodel12[2,1],digits=3), format(ORmodel12[2,2],digits=3), format(ORmodel12[2,3],digits=3))
etable2[19,]<-c('BR',  'Rural', format(ORmodel13[3,1],digits=3), format(ORmodel13[3,2],digits=3), format(ORmodel13[3,3], digits=3))
etable2[20,]<-c('BR',  'Non-metro Urban', format(ORmodel13[2,1],digits=3), format(ORmodel13[2,2],digits=3), format(ORmodel13[2,3],digits=3))
etable2[21,]<-c('KID',  'Rural', format(ORmodel14[3,1],digits=3), format(ORmodel14[3,2],digits=3), format(ORmodel14[3,3], digits=3))
etable2[22,]<-c('KID',  'Non-metro Urban', format(ORmodel14[2,1],digits=3), format(ORmodel14[2,2],digits=3), format(ORmodel14[2,3],digits=3))
etable2[23,]<-c('GON',  'Rural', format(ORmodel15[3,1],digits=3), format(ORmodel15[3,2],digits=3), format(ORmodel15[3,3], digits=3))
etable2[24,]<-c('GON',  'Non-metro Urban', format(ORmodel15[2,1],digits=3), format(ORmodel15[2,2],digits=3), format(ORmodel15[2,3],digits=3))
etable2[25,]<-c('CER',  'Rural',format(ORmodel16[3,1],digits=3), format(ORmodel16[3,2],digits=3), format(ORmodel16[3,3], digits=3))
etable2[26,]<-c('CER',  'Non-metro Urban', format(ORmodel16[2,1],digits=3), format(ORmodel16[2,2],digits=3), format(ORmodel16[2,3],digits=3))
etable2[27,]<-c('COL',  'Rural', format(ORmodel17[3,1],digits=3), format(ORmodel17[3,2],digits=3), format(ORmodel17[3,3], digits=3))
etable2[28,]<-c('COL',  'Non-metro Urban', format(ORmodel17[2,1],digits=3), format(ORmodel17[2,2],digits=3), format(ORmodel17[2,3],digits=3))
etable2[29,]<-c('ST',  'Rural', format(ORmodel18[3,1],digits=3), format(ORmodel18[3,2],digits=3), format(ORmodel18[3,3], digits=3))
etable2[30,]<-c('ST',  'Non-metro Urban', format(ORmodel18[2,1],digits=3), format(ORmodel18[2,2],digits=3), format(ORmodel18[2,3],digits=3))

etable2$OR<-as.numeric(etable2$OR)
etable2$lowCI<-as.numeric(etable2$lowCI)
etable2$UpperCI<-as.numeric(etable2$UpperCI)

ggplot(etable2,aes(x = `RUC`, y =`OR`, color=`RUC`)) +
  geom_point(size = 1)+
  scale_color_manual(values=c("blue", "green"))+
  ylim(0,6) +
   coord_flip() +
  geom_errorbar(aes(ymax = lowCI, ymin = UpperCI), width = 0.2)+
  geom_hline(yintercept = 1, color="black", linetype = 1 ) +
  
theme(axis.title.y=element_blank(),
       axis.ticks.y=element_blank(),
       axis.text.y=element_blank(),
      panel.background=element_blank(),
      strip.background=element_rect(), strip.text = element_text(size=7, face="bold", angle=90), legend.position = "bottom") +

 facet_wrap(~`Cancer_type`, ncol=2, strip.position = "left",labeller = labeller(`Cancer_type` = label_wrap_gen(10)))+
  ylab("OR (95%CI)") +
  xlab("Cancer type")

#install.packages("openxlsx")
library(openxlsx)
```

# Supplementary Table 2
```{r}
#make empty data frame
supp2<-data.frame(matrix(ncol=5, nrow=0))
columns<-c("Cancer type", "Reporting hospital distance category", "OR", "lowCI", "UpperCI")
colnames(supp2)<-columns

supp2[1,]<-c('NHL',  'Intermediate', format(ORmodel5b[2,1], digits=3), format(ORmodel5b[2,2], digits=3), format(ORmodel5b[2,3], digits=3))
supp2[2,]<-c('NHL', 'Long', format(ORmodel5b[3,1], digits=3), format(ORmodel5b[3,2], digits=3), format(ORmodel5b[3,3], digits=3))
supp2[3,]<-c('HL',  'Intermediate', format(ORmodel5c[2,1],digits=3), format(ORmodel5c[2,2], digits=3), format(ORmodel5c[2,3], digits=3))
supp2[4,]<-c('HL',  'Long', format(ORmodel5c[3,1],digits=3), format(ORmodel5c[3,2], digits=3), format(ORmodel5c[3,3], digits=3))
supp2[5,]<-c('OS',  'Intermediate', format(ORmodel6a[2,1],digits=3), format(ORmodel6a[2,2],digits=3), format(ORmodel6a[2,3],digits=3))
supp2[6,]<-c('OS',  'Long', format(ORmodel6a[3,1],digits=3), format(ORmodel6a[3,2],digits=3), format(ORmodel6a[3,3], digits=3))
supp2[7,]<-c('STS',  'Intermediate', format(ORmodel7a[2,1],digits=3), format(ORmodel7a[2,2],digits=3), format(ORmodel7a[2,3],digits=3))
supp2[8,]<-c('STS',  'Long', format(ORmodel7a[3,1],digits=3),
format(ORmodel7a[3,2],digits=3), format(ORmodel7a[3,3], digits=3))
supp2[9,]<-c('GCT',  'Intermediate', format(ORmodel8a[2,1],digits=3), format(ORmodel8a[2,2],digits=3), format(ORmodel8a[2,3],digits=3))
supp2[10,]<-c('GCT',  'Long', format(ORmodel8a[3,1],digits=3), format(ORmodel8a[3,2],digits=3), format(ORmodel8a[3,3], digits=3))
supp2[11,]<-c('MEL',  'Intermediate', format(ORmodel9a[2,1],digits=3), format(ORmodel9a[2,2],digits=3), format(ORmodel9a[2,3],digits=3))
supp2[12,]<-c('MEL',  'Long', format(ORmodel9a[3,1],digits=3), format(ORmodel9a[3,2],digits=3), format(ORmodel9a[3,3], digits=3))
supp2[13,]<-c('THY',  'Intermediate', format(ORmodel10a[2,1],digits=3), format(ORmodel10a[2,2],digits=3), format(ORmodel10a[2,3],digits=3))
supp2[14,]<-c('THY',  'Long', format(ORmodel10a[3,1],digits=3), format(ORmodel10a[3,2],digits=3), format(ORmodel10a[3,3], digits=3))
supp2[15,]<-c('HN',  'Intermediate', format(ORmodel11a[2,1],digits=3), format(ORmodel11a[2,2],digits=3), format(ORmodel11a[2,3],digits=3))
supp2[16,]<-c('HN',  'Long', format(ORmodel11a[3,1],digits=3), format(ORmodel11a[3,2],digits=3), format(ORmodel11a[3,3], digits=3))
supp2[17,]<-c('LUNG',  'Intermediate', format(ORmodel12a[2,1],digits=3), format(ORmodel12a[2,2],digits=3), format(ORmodel12a[2,3],digits=3))
supp2[18,]<-c('LUNG',  'Long', format(ORmodel12a[3,1],digits=3), format(ORmodel12a[3,2],digits=3), format(ORmodel12a[3,3], digits=3))
supp2[19,]<-c('BREA',  'Intermediate', format(ORmodel13a[2,1],digits=3), format(ORmodel13a[2,2],digits=3), format(ORmodel13a[2,3],digits=3))
supp2[20,]<-c('BREA',  'Long', format(ORmodel13a[3,1],digits=3), format(ORmodel13a[3,2],digits=3), format(ORmodel13a[3,3], digits=3))
supp2[21,]<-c('KID',  'Intermediate', format(ORmodel14a[2,1],digits=3), format(ORmodel14a[2,2],digits=3), format(ORmodel14a[2,3],digits=3))
supp2[22,]<-c('KID',  'Long', format(ORmodel14a[3,1],digits=3), format(ORmodel14a[3,2],digits=3), format(ORmodel14a[3,3], digits=3))
supp2[23,]<-c('GON',  'Intermediate', format(ORmodel15a[2,1],digits=3), format(ORmodel15a[2,2],digits=3), format(ORmodel15a[2,3],digits=3))
supp2[24,]<-c('GON',  'Long', format(ORmodel15a[3,1],digits=3), format(ORmodel15a[3,2],digits=3), format(ORmodel15a[3,3], digits=3))
supp2[25,]<-c('CERV',  'Intermediate', format(ORmodel16a[2,1],digits=3), format(ORmodel16a[2,2],digits=3), format(ORmodel16a[2,3],digits=3))
supp2[26,]<-c('CERV',  'Long',format(ORmodel16a[3,1],digits=3), format(ORmodel16a[3,2],digits=3), format(ORmodel16a[3,3], digits=3))
supp2[27,]<-c('COL',  'Intermediate', format(ORmodel17a[2,1],digits=3), format(ORmodel17a[2,2],digits=3), format(ORmodel17a[2,3],digits=3))
supp2[28,]<-c('COL',  'Long', format(ORmodel17a[3,1],digits=3), format(ORmodel17a[3,2],digits=3), format(ORmodel17a[3,3], digits=3))
supp2[29,]<-c('STOM',  'Intermediate', format(ORmodel18a[2,1],digits=3), format(ORmodel18a[2,2],digits=3), format(ORmodel18a[2,3],digits=3))
supp2[30,]<-c('STOM',  'Long', format(ORmodel18a[3,1],digits=3), format(ORmodel18a[3,2],digits=3), format(ORmodel18a[3,3], digits=3))

supp2$Cancer_type_f=factor(supp2$Cancer_type, levels=c("BREA",  "CERV", "COL","GCT","GON", "HL","HN","LUNG", "KID",  "MEL", "NHL", "OS", "STOM", "STS", "THY"))

supp2$OR<-as.numeric(supp2$OR)
supp2$lowCI<-as.numeric(supp2$lowCI)
supp2$UpperCI<-as.numeric(supp2$UpperCI)

```

#GCD figure
```{r}
ggplot(supp2,aes(x = `GCD category`, y =`OR`, color=`GCD category`)) +
  geom_point(size = 1)+
  scale_color_manual(values=c("blue", "green"), name="", labels=c("Intermediate (>12.5 to <50 miles) vs. Short (<12.5 miles)","Long (>=50 miles) vs. Short (<12.5 miles)")) +
  ylim(0,4) +
   coord_flip() +
  geom_errorbar(aes(ymax = lowCI, ymin = UpperCI), width = 0.1)+
  geom_hline(yintercept = 1, color="black", linetype = 1 ) +

theme(axis.title.x = element_text(face="bold"),
      axis.title.y=element_blank(),
       axis.ticks.y=element_blank(),
       axis.text.y=element_blank(),
      axis.text.x=element_text(face="bold"),
      axis.line.x=element_line(size=0.5, colour="black", linetype=1),
      panel.background=element_blank(),
      strip.background=element_rect(), strip.text = element_text(size=8, face="bold", angle=90), legend.position = "bottom", legend.text=element_text(face="bold"))+
  
 facet_wrap(~`Cancer_type_f`, ncol=2, strip.position = "left", dir="v", labeller = labeller(`Cancer type` = label_wrap_gen(10)))+
  ylab("OR (95%CI)") +
  xlab("Cancer type")
ggsave("Figure2.pdf")


```

#Overall mortality in 2015 KM curves
```{r, warning=FALSE}
#By RUCA
RUCA.surv <- survfit(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ RUCC, data=analytic_dt_lb)
survdiff(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ RUCC, data=analytic_dt_lb)



a<-ggsurvplot(RUCA.surv, ylim=c(0.6,1),  size=0.3, conf.int=TRUE, censor=TRUE, legend="bottom", legend.title="",legend.labs = c("RUCC 9-category 1 (most metro)", "RUCC 9-category 2", "RUCC 9-category 3", "RUCC 9-category 4", "RUCC 9-category 5", "RUCC 9-category 6", "RUCC 9-category 7", "RUCC 9-category 8", "RUCC 9-category (most rural)"), font.legend="bold", font.x="bold", font.y="bold", censor.size=0.7, xlab="Time (months)", tables.theme = clean_theme()) + guides(colour = guide_legend(nrow = 3)) 
a
ggsave("figure3a.pdf")

pairwise_survdiff(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ RUCC, data=analytic_dt_lb, rho = 0)

RUCA3.surv <- survfit(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead) ~ RUCC3, data=analytic_dt_lb)
survdiff(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ RUCC3, data=analytic_dt_lb)

b<-ggsurvplot(RUCA3.surv, data=analytic_dt_lb,  ylim=c(0.6,1),  size=0.3, conf.int=TRUE, censor=TRUE, font.x="bold", font.y="bold", censor.size=0.7, xlab="Time (months)", tables.theme = clean_theme(),legend.labs = c("RUCC 3-category (Metro)", "RUCC 3-category (Non-metro Urban)", "RUCC 3-category (Rural)"),
, legend="bottom", legend.title="", font.legend="bold")+ guides(colour = guide_legend(nrow = 3))
b

ggsave("figure3b.pdf")


GCD.surv <- survfit(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead) ~ GCD, data=analytic_dt_lb)
survdiff(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ GCD, data=analytic_dt_lb)

c<-ggsurvplot(GCD.surv,  ylim=c(0.6,1),  size=0.3, conf.int=TRUE, censor=TRUE, legend="bottom", legend.title="", legend.labs = c("Short (<=12.5 miles)", "Intermediate (>12.5 to <50 miles)", "Long (>=50 miles)"), font.legend="bold", font.x="bold", font.y="bold",  censor.size=0.5, xlab="Time (months)",tables.theme = clean_theme()) + guides(colour = guide_legend(nrow = 3)) 
c
ggsave("figure3c.pdf")


c2<-pairwise_survdiff(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ GCD, data=analytic_dt_lb, rho = 0)
c2

# RUCC3
KM_CT <- function(inc_value, ab){
RUCA3.surv <- survfit(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead) ~ RUCC3, 
                      analytic_dt_lb[analytic_dt_lb[["cantype"]]==inc_value,])

ab<-ggsurvplot(RUCA3.surv,  ylim=c(0,1),  size=0.3, conf.int=TRUE, censor=TRUE, legend="bottom", legend.title="",legend.labs = c("RUCC 3-category (Metro)", "RUCC 3-category (Non-metro Urban)", "RUCC 3-category (Rural)"), font.legend="bold", font.x="bold", font.y="bold", censor.size=0.7, xlab="Time (months)",tables.theme = clean_theme(), title=inc_value)

ab
}

inc_value="2.1 Non-Hodgkin lymphoma"
KM_CT("2.1 Non-Hodgkin lymphoma", NHL)
inc_value="2.2 Hodgkin lymphoma"
KM_CT("2.2 Hodgkin lymphoma", HL)
inc_value="4.0 Osseous and chondromatous neoplasms"
KM_CT("4.0 Osseous and chondromatous neoplasms")
inc_value="4.5.0 Soft Tissue Sarcomas"
KM_CT("5.0 Soft Tissue Sarcomas")
inc_value="6.1 Germ cell and trophoblastic neoplasms of gonads"
KM_CT("6.1 Germ cell and trophoblastic neoplasms of gonads")
inc_value="7.1 Melanoma"
KM_CT("7.1 Melanoma")
inc_value="8.1 Thyroid carcinoma"
KM_CT("8.1 Thyroid carcinoma")
inc_value="8.2 Carcinoma of head and neck"
KM_CT("8.2 Carcinoma of head and neck")
inc_value="8.3 Carcinoma of trachea, bronchus, and lung "
KM_CT("8.3 Carcinoma of trachea, bronchus, and lung")
inc_value="8.4 Carcinoma of breast"
KM_CT("8.4 Carcinoma of breast")
inc_value="8.5.1 Carcinoma of kidney"
KM_CT("8.5.1 Carcinoma of kidney")
inc_value="8.5.3 Carcinoma of gonads"
KM_CT("8.5.3 Carcinoma of gonads")
inc_value="8.5.4 Carcinoma of cervix"
KM_CT("8.5.4 Carcinoma of cervix")
inc_value="8.6.1 Carcinoma of colon and rectum"
KM_CT("8.6.1 Carcinoma of colon and rectum")
inc_value="8.6.2 Carcinoma of stomach"
KM_CT("8.6.2 Carcinoma of stomach")
inc_value="3.0 CNS and Other Intracranial and Intraspinal Neoplasms (all behaviors)"
KM_CT("3.0 CNS and Other Intracranial and Intraspinal Neoplasms (all behaviors)")
inc_value="1.0 Leukemias"
KM_CT("1.0 Leukemias")

# GCD
KM_CTb <- function(inc_value, ab){
GCD.surv <- survfit(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead) ~ GCD, 
                      analytic_dt_lb[analytic_dt_lb[["cantype"]]==inc_value,])
ab<-ggsurvplot(RUCA3.surv,  ylim=c(0,1),  size=0.3, conf.int=TRUE, censor=TRUE, legend="bottom", legend.title="",legend.labs = c("Short (<12.5 miles)", "Intermediate (>12.5 to <50 miles)","Long (>=50 miles)"), font.legend="bold", font.x="bold", font.y="bold", censor.size=0.7, xlab="Time (months)",tables.theme = clean_theme(), title=inc_value) + guides(colour = guide_legend(nrow = 1)) 
ab

}
inc_value="2.1 Non-Hodgkin lymphoma"
KM_CTb("2.1 Non-Hodgkin lymphoma")
inc_value="2.2 Hodgkin lymphoma"
KM_CTb("2.2 Hodgkin lymphoma")
inc_value="4.0 Osseous and chondromatous neoplasms"
KM_CTb("4.0 Osseous and chondromatous neoplasms")
inc_value="4.05.0 Soft Tissue Sarcomas"
KM_CTb("5.0 Soft Tissue Sarcomas")
inc_value="6.1 Germ cell and trophoblastic neoplasms of gonads"
KM_CTb("6.1 Germ cell and trophoblastic neoplasms of gonads")
inc_value="7.1 Melanoma"
KM_CTb("7.1 Melanoma")
inc_value="8.1 Thyroid carcinoma"
KM_CTb("8.1 Thyroid carcinoma")
inc_value="8.2 Carcinoma of head and neck"
KM_CTb("8.2 Carcinoma of head and neck")
inc_value="8.3 Carcinoma of trachea, bronchus, and lung "
KM_CTb("8.3 Carcinoma of trachea, bronchus, and lung")
inc_value="8.4 Carcinoma of breast"
KM_CTb("8.4 Carcinoma of breast")
inc_value="8.5.1 Carcinoma of kidney"
KM_CTb("8.5.1 Carcinoma of kidney")
inc_value="8.5.3 Carcinoma of gonads"
KM_CTb("8.5.3 Carcinoma of gonads")
inc_value="8.5.4 Carcinoma of cervix"
KM_CTb("8.5.4 Carcinoma of cervix")
inc_value="8.6.1 Carcinoma of colon and rectum"
KM_CTb("8.6.1 Carcinoma of colon and rectum")
inc_value="8.6.2 Carcinoma of stomach"
KM_CTb("8.6.2 Carcinoma of stomach")
inc_value="3.0 CNS and Other Intracranial and Intraspinal Neoplasms (all behaviors)"
KM_CTb("3.0 CNS and Other Intracranial and Intraspinal Neoplasms (all behaviors)")
inc_value="1.0 Leukemias"
KM_CTb("1.0 Leukemias")
```

#Survival by stage for discussion
```{r}
stage.surv <- survfit(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, data=analytic_dt_lb)
survdiff(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, analytic_dt_lb[which(analytic_dt_lb$cantype =="7.1 Melanoma"),])

a<-ggsurvplot(stage.surv, ylim=c(0,1),  size=0.3, conf.int=TRUE, censor=TRUE, legend="bottom", legend.title="", font.x="bold", font.y="bold", censor.size=0.7, xlab="Time (months)", tables.theme = clean_theme(), title="7.1 Melanoma") + guides(colour = guide_legend(nrow = 3)) 
a

stage.surv <- survfit(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, data=analytic_dt_lb)
survdiff(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, analytic_dt_lb[which(analytic_dt_lb$cantype =="8.6.1 Carcinoma of colon and rectum"),])

b<-ggsurvplot(stage.surv, ylim=c(0,1),  size=0.3, conf.int=TRUE, censor=TRUE, legend="bottom", legend.title="", font.x="bold", font.y="bold", censor.size=0.7, xlab="Time (months)", tables.theme = clean_theme(), title="8.6.1 Carcinoma of colon and rectum") + guides(colour = guide_legend(nrow = 3)) 
b

stage.surv <- survfit(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, data=analytic_dt_lb)
survdiff(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, analytic_dt_lb[which(analytic_dt_lb$cantype =="6.1 Germ cell and trophoblastic neoplasms of gonads"),])

c<-ggsurvplot(stage.surv, ylim=c(0,1),  size=0.3, conf.int=TRUE, censor=TRUE, legend="bottom", legend.title="", font.x="bold", font.y="bold", censor.size=0.7, xlab="Time (months)", tables.theme = clean_theme(), title="6.1 Germ cell and trophoblastic neoplasms of gonads") + guides(colour = guide_legend(nrow = 3)) 
c

stage.surv <- survfit(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, data=analytic_dt_lb)
survdiff(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, analytic_dt_lb[which(analytic_dt_lb$cantype =="2.1 Non-Hodgkin lymphoma"),])

d<-ggsurvplot(stage.surv, ylim=c(0,1),  size=0.3, conf.int=TRUE, censor=TRUE, legend="bottom", legend.title="", font.x="bold", font.y="bold", censor.size=0.7, xlab="Time (months)", tables.theme = clean_theme(), title="2.1 Non-Hodgkin lymphoma") + guides(colour = guide_legend(nrow = 3)) 
d

stage.surv <- survfit(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, data=analytic_dt_lb)
survdiff(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, analytic_dt_lb[which(analytic_dt_lb$cantype =="2.2 Hodgkin lymphoma"),])

e<-ggsurvplot(stage.surv, ylim=c(0,1),  size=0.3, conf.int=TRUE, censor=TRUE, legend="bottom", legend.title="", font.x="bold", font.y="bold", censor.size=0.7, xlab="Time (months)", tables.theme = clean_theme(), title="2.2 Hodgkin lymphoma") + guides(colour = guide_legend(nrow = 3)) 
e

stage.surv <- survfit(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, data=analytic_dt_lb)
survdiff(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, analytic_dt_lb[which(analytic_dt_lb$cantype =="8.1 Thyroid carcinoma"),])

f<-ggsurvplot(stage.surv, ylim=c(0,1),  size=0.3, conf.int=TRUE, censor=TRUE, legend="bottom", legend.title="", font.x="bold", font.y="bold", censor.size=0.7, xlab="Time (months)", tables.theme = clean_theme(), title="8.1 Thyroid carcinoma") + guides(colour = guide_legend(nrow = 3)) 
f

```


# Table 3: Unadjusted Cox PH impact of Rural/Urban on vital status
```{r}
#RUCC
unadja<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC, analytic_dt_lb) 
summary(unadja)

#RUCC3
unadjb<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3, analytic_dt_lb) 
summary(unadjb)

#GCD
unadjc<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD, analytic_dt_lb) 
summary(unadjc)

#sum person years RUCC
aggregate(analytic_dt_lb$DX_LASTCONTACT_DEATH_MONTHS,  by=list(category=analytic_dt_lb$RUCC), FUN=sum)
table(analytic_dt_lb$dead, analytic_dt_lb$RUCC)

#sum person years RUCC3
aggregate(analytic_dt_lb$DX_LASTCONTACT_DEATH_MONTHS,  by=list(category=analytic_dt_lb$RUCC3), FUN=sum)
table(analytic_dt_lb$dead, analytic_dt_lb$RUCC3)

#sum person years GCD
aggregate(analytic_dt_lb$DX_LASTCONTACT_DEATH_MONTHS,  by=list(category=analytic_dt_lb$GCD), FUN=sum)
table(analytic_dt_lb$dead, analytic_dt_lb$GCD)
```

# Proportional hazards assumption for unadjusted models
```{r}
#RUCC
test.pha<-cox.zph(unadja, terms=FALSE)
test.pha

ggcoxzph(test.pha)

#RUCC3
test.phb<-cox.zph(unadjb, terms=FALSE)
test.phb

ggcoxzph(test.phb)

#GCG
test.phc<-cox.zph(unadjc, terms=FALSE)
test.phc

ggcoxzph(test.phc)
```

# Table 3: Adjusted Cox PH impact of Rural/Urban and GCD on vital status
```{r}
#Adusted for age, sex, race, and education
adja<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC + AGE + SEX + RACE + educ, analytic_dt_lb) 
summary(adja)

adjb<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + AGE + SEX + RACE + educ, analytic_dt_lb) 
summary(adjb)

adjc<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ, analytic_dt_lb) 
summary(adjc)

adjd<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + RUCC3, analytic_dt_lb) 
summary(adjd)

#adjust for stage as a mediator
adje<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC + AGE + SEX + RACE + educ +stage, analytic_dt_lb) 
summary(adje)

adjf<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + AGE + SEX + RACE + educ +stage, analytic_dt_lb) 
summary(adjf)

adjg<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ +stage, analytic_dt_lb) 
summary(adjg)

```
#Proportional hazards assumption for adjusted models
```{r}
#RUCC
test.pha<-cox.zph(adja, terms=TRUE)
test.pha

ggcoxzph(test.pha)
plot(test.pha, resid=FALSE)

#RUCC3
test.phb<-cox.zph(adjb, terms=TRUE)
test.phb

ggcoxzph(test.phb)
plot(test.phb, resid=FALSE)

#GCD
test.phc<-cox.zph(adjc, terms=TRUE)
test.phc

ggcoxzph(test.phc)
plot(test.phc, resid=FALSE)
```
#Supplemenatary TAble 3-ph assumption violation models
```{r}
adjc<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + strata(SEX) + strata(RACE) + strata(educ), analytic_dt_lb) 
summary(adjc)

#By time interval to get HRs

#need to change censorship and follow-up time
#0-60 months
analytic_dt_lb$survt60<-ifelse(analytic_dt_lb$DX_LASTCONTACT_DEATH_MONTHS>60, 60, analytic_dt_lb$DX_LASTCONTACT_DEATH_MONTHS)
analytic_dt_lb$status60<-ifelse(analytic_dt_lb$DX_LASTCONTACT_DEATH_MONTHS>60&analytic_dt_lb$dead==1, 0, analytic_dt_lb$dead)

interval0to60<-coxph(Surv(survt60, status60)~GCD + AGE + strata(SEX) + strata(RACE) + strata(educ), analytic_dt_lb) 
summary(interval0to60)

HRmodel<-exp(cbind(HR = coef(interval0to60), confint(interval0to60))) #calculate HRs and 95% CIs
  HRmodel #print HRs and 95% CIs

#>60 months--need to exclude people not at risk
analytic_dt_lb2<-analytic_dt_lb[which(analytic_dt_lb$DX_LASTCONTACT_DEATH_MONTHS>60),]
intervalgt60<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + strata(SEX) + strata(RACE) + strata(educ), analytic_dt_lb2) 
summary(intervalgt60)

#GCD
test.ph60<-cox.zph(interval0to60, terms=TRUE)
test.ph60

ggcoxzph(test.ph60)
plot(test.ph60, resid=FALSE)

test.phgt60<-cox.zph(intervalgt60)
test.phgt60

ggcoxzph(test.phgt60)
plot(test.phgt60, resid=FALSE)

supp3<-data.frame(matrix(ncol=4, nrow=0))
columns<-c("Reporting hospital distance", "HR", "lowCI", "UpperCI")
colnames(supp3)<-columns

supp3[1,]<-c("short", "1.0 (reference)", "", "")
supp3[2,]<-c("intermediate", format(HRmodel[1,1], digits=3), format(HRmodel[1,2], digits=3), format(HRmodel[1,3], digits=3))
supp3[3,]<-c("long", format(HRmodel[2,1], digits=3), format(HRmodel[2,2], digits=3), format(HRmodel[2,3], digits=3))

```
#Modification by sex, race, and cancer type
```{r}
# RUCC3

# SEX
adjg<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + AGE + SEX + RACE + educ, analytic_dt_lb) 
summary(adjg)

adjh<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + AGE + SEX + RACE + educ +  RUCC3*SEX, analytic_dt_lb) 
summary(adjh) # no interaction by sex

lrtest(adjg, adjh)

# RACE
adji<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + AGE + SEX + RACE + educ, analytic_dt_lb) 
summary(adji)

adjj<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + AGE + SEX + RACE + educ +  RUCC3*RACE, analytic_dt_lb) 
summary(adjj) # no interaction by RACE

lrtest(adji, adjj)

# cancer type
adjc<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + AGE + SEX + RACE + educ  +  cantype, analytic_dt_lb) 
summary(adjc)

adjd<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + AGE + SEX + RACE + educ +  RUCC3*cantype, analytic_dt_lb) 
summary(adjd)

lrtest(adjc, adjd) # no interaction by cancer type


# GCD
# SEX
adjk<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ, analytic_dt_lb) 
summary(adjk)

adjl<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ +  GCD*SEX, analytic_dt_lb) 
summary(adjl) 

lrtest(adjk, adjl) # no interaction by sex


# RACE
adjm<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ, analytic_dt_lb) 
summary(adjm)

adjn<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ +  GCD*RACE, analytic_dt_lb) 
summary(adjn) 

lrtest(adjm, adjn) # no interaction by RACE

# cancer type
adje<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + cantype, analytic_dt_lb) 
summary(adje)

adjf<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ +  cantype + GCD*cantype, analytic_dt_lb) 
summary(adjf)

lrtest(adje, adjf)

```

#Differences in survival by cancer type in association with GCD
```{r}
# 2.1 Non-Hodgkin lymphoma
modelNHL<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ, subset=analytic_dt_lb$cantype=="2.1 Non-Hodgkin lymphoma", analytic_dt_lb) 
summary(modelNHL)

 HRmodelNHL<-exp(cbind(HR = coef(modelNHL), confint(modelNHL))) #calculate HRs and 95% CIs
  HRmodelNHL #print HRs and 95% CIs
  
#2.2 Hodgkin lymphoma
modelHL<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ, subset=analytic_dt_lb$cantype=="2.2 Hodgkin lymphoma", analytic_dt_lb) 
summary(modelHL)

 HRmodelHL<-exp(cbind(HR = coef(modelHL), confint(modelHL))) #calculate HRs and 95% CIs
  HRmodelHL #print HRs and 95% CIs
  
#4.0 Osseous and chondromatous neoplasms
modelOSS<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ, subset=analytic_dt_lb$cantype=="4.0 Osseous and chondromatous neoplasms", analytic_dt_lb) 
summary(modelOSS)

 HRmodelOSS<-exp(cbind(HR = coef(modelOSS), confint(modelOSS))) #calculate HRs and 95% CIs
  HRmodelOSS #print HRs and 95% CIs
  
#5.0 Soft Tissue Sarcomas 
modelSTS<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ, subset=analytic_dt_lb$cantype=="5.0 Soft Tissue Sarcomas", analytic_dt_lb) 
summary(modelSTS)

HRmodelSTS<-exp(cbind(HR = coef(modelSTS), confint(modelSTS))) #calculate HRs and 95% CIs
  HRmodelSTS #print HRs and 95% CIs

#6.1 Germ cell and trophoblastic neoplasms of gonads 
modelGCT<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ, subset=analytic_dt_lb$cantype=="6.1 Germ cell and trophoblastic neoplasms of gonads", analytic_dt_lb) 
summary(modelGCT)
HRmodelGCT<-exp(cbind(HR = coef(modelGCT), confint(modelGCT))) #calculate HRs and 95% CIs
  HRmodelGCT #print HRs and 95% CIs

#7.1 Melanoma 
modelMEL<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ, subset=analytic_dt_lb$cantype=="7.1 Melanoma", analytic_dt_lb) 
summary(modelMEL)
HRmodelMEL<-exp(cbind(HR = coef(modelMEL), confint(modelMEL))) #calculate HRs and 95% CIs
  HRmodelMEL #print HRs and 95% CIs
  

#sex interaction model
modelTHY<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + SEX*GCD, subset=analytic_dt_lb$cantype=="8.1 Thyroid carcinoma", analytic_dt_lb) 
summary(modelTHY)

HRmodelTHY<-exp(cbind(HR = coef(modelTHY), confint(modelTHY))) #calculate HRs and 95% CIs
  HRmodelTHY #print HRs and 95% CIs

#8.2 Carcinoma of head and neck 
modelHEAD<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ, subset=analytic_dt_lb$cantype=="8.2 Carcinoma of head and neck", analytic_dt_lb) 
summary(modelHEAD)
HRmodelHEAD<-exp(cbind(HR = coef(modelHEAD), confint(modelHEAD))) #calculate HRs and 95% CIs
  HRmodelHEAD #print HRs and 95% CIs

#8.3 Carcinoma of trachea,bronchus, and lung 
modelLUNG<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ, subset=analytic_dt_lb$cantype=="8.3 Carcinoma of trachea, bronchus, and lung", analytic_dt_lb) 
summary(modelLUNG)
HRmodelLUNG<-exp(cbind(HR = coef(modelLUNG), confint(modelLUNG))) #calculate HRs and 95% CIs
  HRmodelLUNG #print HRs and 95% CIs
  
#8.4 Carcinoma of breast
modelBREAST<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ, subset=analytic_dt_lb$cantype=="8.4 Carcinoma of breast", analytic_dt_lb) 
summary(modelBREAST)
HRmodelBREAST<-exp(cbind(HR = coef(modelBREAST), confint(modelBREAST))) #calculate HRs and 95% CIs
  HRmodelBREAST #print HRs and 95% CIs
  
#8.5.1 Carcinoma of kidney 
modelKID<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ, subset=analytic_dt_lb$cantype=="8.5.1 Carcinoma of kidney", analytic_dt_lb) 
summary(modelKID)
HRmodelKID<-exp(cbind(HR = coef(modelKID), confint(modelKID))) #calculate HRs and 95% CIs
  HRmodelKID #print HRs and 95% CIs

#8.5.3 Carcinoma of gonads
modelGON<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ, subset=analytic_dt_lb$cantype=="8.5.3 Carcinoma of gonads", analytic_dt_lb) 
summary(modelGON)
HRmodelGON<-exp(cbind(HR = coef(modelGON), confint(modelGON))) #calculate HRs and 95% CIs
  HRmodelGON #print HRs and 95% CIs
  
#8.5.4 Carcinoma of cervix 
modelCERV<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ, subset=analytic_dt_lb$cantype=="8.5.4 Carcinoma of cervix", analytic_dt_lb) 
summary(modelCERV)
HRmodelCERV<-exp(cbind(HR = coef(modelCERV), confint(modelCERV))) #calculate HRs and 95% CIs
  HRmodelCERV #print HRs and 95% CIs
  
#8.6.1 Carcinoma of colon and rectum
modelCOL<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ, subset=analytic_dt_lb$cantype=="8.6.1 Carcinoma of colon and rectum", analytic_dt_lb) 
summary(modelCOL)
 HRmodelCOL<-exp(cbind(HR = coef(modelCOL), confint(modelCOL))) #calculate HRs and 95% CIs
  HRmodelCOL #print HRs and 95% CIs
  
#8.6.2 Carcinoma of stomach 
modelSTOM<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ, subset=analytic_dt_lb$cantype=="8.6.2 Carcinoma of stomach", analytic_dt_lb) 
summary(modelSTOM)
HRmodelSTOM<-exp(cbind(HR = coef(modelSTOM), confint(modelSTOM))) #calculate HRs and 95% CIs
  HRmodelSTOM #print HRs and 95% CIs
  
#Brain
modelBrain<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ, subset=analytic_dt_lb$cantype=="3.0 CNS and Other Intracranial and Intraspinal Neoplasms (all behaviors)", analytic_dt_lb) 
summary(modelBrain)
HRmodelBrain<-exp(cbind(HR = coef(modelBrain), confint(modelBrain))) #calculate HRs and 95% CIs
  HRmodelBrain #print HRs and 95% CIs
  
#Leukemia
modelLeuk<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ, subset=analytic_dt_lb$cantype=="1.0 Leukemias", analytic_dt_lb) 
summary(modelLeuk)
HRmodelLeuk<-exp(cbind(HR = coef(modelLeuk), confint(modelLeuk))) #calculate HRs and 95% CIs
  HRmodelLeuk #print HRs and 95% CIs
```
#Figure based on above results
#Supplementary Table 4
```{r}
#make empty data frame
supp4<-data.frame(matrix(ncol=5, nrow=0))
columns<-c("Cancer type", "Reporting hospital distance category","HR", "lowCI", "UpperCI")
colnames(supp4)<-columns

supp4[1,]<-c('NHL',  'Intermediate', format(HRmodelNHL[1,1], digits=3), format(HRmodelNHL[1,2], digits=3), format(HRmodelNHL[1,3], digits=3))

supp4[2,]<-c('NHL',  'Long', format(HRmodelNHL[2,1], digits=3), format(HRmodelNHL[2,2], digits=3), format(HRmodelNHL[2,3], digits=3))

supp4[3,]<-c('HL',  'Intermediate', format(HRmodelHL[1,1], digits=3), format(HRmodelHL[1,2], digits=3), format(HRmodelHL[1,3], digits=3))
supp4[4,]<-c('HL',  'Long', format(HRmodelHL[2,1], digits=3), format(HRmodelHL[2,2], digits=3), format(HRmodelHL[2,3], digits=3))

supp4[5,]<-c('OS',  'Intermediate', format(HRmodelOSS[1,1], digits=3), format(HRmodelOSS[1,2], digits=3), format(HRmodelOSS[1,3], digits=3))
supp4[6,]<-c('OS',  'Long', format(HRmodelOSS[2,1], digits=3), format(HRmodelOSS[2,2], digits=3), format(HRmodelOSS[2,3], digits=3))

supp4[7,]<-c('STS',  'Intermediate', format(HRmodelSTS[1,1], digits=3), format(HRmodelSTS[1,2], digits=3), format(HRmodelSTS[1,3], digits=3))
supp4[8,]<-c('STS',  'Long', format(HRmodelSTS[2,1], digits=3), format(HRmodelSTS[2,2], digits=3), format(HRmodelSTS[2,3], digits=3))

supp4[9,]<-c('GCT',  'Intermediate', format(HRmodelGCT[1,1], digits=3), format(HRmodelGCT[1,2], digits=3), format(HRmodelGCT[1,3], digits=3))
supp4[10,]<-c('GCT',  'Long', format(HRmodelGCT[2,1], digits=3), format(HRmodelGCT[2,2], digits=3), format(HRmodelGCT[2,3], digits=3))

supp4[11,]<-c('MEL',  'Intermediate', format(HRmodelMEL[1,1], digits=3), format(HRmodelMEL[1,2], digits=3), format(HRmodelMEL[1,3], digits=3))
supp4[12,]<-c('MEL',  'Long', format(HRmodelMEL[2,1], digits=3), format(HRmodelMEL[2,2], digits=3), format(HRmodelMEL[2,3], digits=3))

supp4[13,]<-c('THY',  'Intermediate', format(HRmodelTHY[1,1], digits=3), format(HRmodelTHY[1,2], digits=3), format(HRmodelTHY[1,3], digits=3))
supp4[14,]<-c('THY',  'Long', format(HRmodelTHY[2,1], digits=3), format(HRmodelTHY[2,2], digits=3), format(HRmodelTHY[2,3], digits=3))

supp4[15,]<-c('HN',  'Intermediate', format(HRmodelHEAD[1,1], digits=3), format(HRmodelHEAD[1,2], digits=3), format(HRmodelHEAD[1,3], digits=3))
supp4[16,]<-c('HN',  'Long', format(HRmodelHEAD[2,1], digits=3), format(HRmodelHEAD[2,2], digits=3), format(HRmodelHEAD[2,3], digits=3))

supp4[17,]<-c('LUNG',  'Intermediate', format(HRmodelLUNG[1,1], digits=3), format(HRmodelLUNG[1,2], digits=3), format(HRmodelLUNG[1,3], digits=3))
supp4[18,]<-c('LUNG',  'Long', format(HRmodelLUNG[2,1], digits=3), format(HRmodelLUNG[2,2], digits=3), format(HRmodelLUNG[2,3], digits=3))

supp4[19,]<-c('BREA',  'Intermediate', format(HRmodelBREAST[1,1], digits=3), format(HRmodelBREAST[1,2], digits=3), format(HRmodelBREAST[1,3], digits=3))
supp4[20,]<-c('BREA',  'Long', format(HRmodelBREAST[2,1], digits=3), format(HRmodelBREAST[2,2], digits=3), format(HRmodelBREAST[2,3], digits=3))

supp4[21,]<-c('KID',  'Intermediate', format(HRmodelKID[1,1], digits=3), format(HRmodelKID[1,2], digits=3), format(HRmodelKID[1,3], digits=3))
supp4[22,]<-c('KID',  'Long', format(HRmodelKID[2,1], digits=3), format(HRmodelKID[2,2], digits=3), format(HRmodelKID[2,3], digits=3))

supp4[23,]<-c('GON',  'Intermediate', format(HRmodelGON[1,1], digits=3), format(HRmodelGON[1,2], digits=3), format(HRmodelGON[1,3], digits=3))
supp4[24,]<-c('GON',  'Long', format(HRmodelGON[2,1], digits=3), format(HRmodelGON[2,2], digits=3), format(HRmodelGON[2,3], digits=3))

supp4[25,]<-c('CERV',  'Intermediate', format(HRmodelCERV[1,1], digits=3), format(HRmodelCERV[1,2], digits=3), format(HRmodelCERV[1,3], digits=3))
supp4[26,]<-c('CERV',  'Long', format(HRmodelCERV[2,1], digits=3), format(HRmodelCERV[2,2], digits=3), format(HRmodelCERV[2,3], digits=3))

supp4[27,]<-c('COL',  'Intermediate', format(HRmodelCOL[1,1], digits=3), format(HRmodelCOL[1,2], digits=3), format(HRmodelCOL[1,3], digits=3))
supp4[28,]<-c('COL',  'Long', format(HRmodelCOL[2,1], digits=3), format(HRmodelCOL[2,2], digits=3), format(HRmodelCOL[2,3], digits=3))

supp4[29,]<-c('STOM',  'Intermediate', format(HRmodelSTOM[1,1], digits=3), format(HRmodelSTOM[1,2], digits=3), format(HRmodelSTOM[1,3], digits=3))
supp4[30,]<-c('STOM',  'Long', format(HRmodelSTOM[2,1], digits=3), format(HRmodelSTOM[2,2], digits=3), format(HRmodelSTOM[2,3], digits=3))

supp4[31,]<-c('BRAI', 'Intermediate',  format(HRmodelBrain[1,1], digits=3), format(HRmodelBrain[1,2], digits=3), format(HRmodelBrain[1,3], digits=3))
supp4[32,]<-c('BRAI',  'Long', format(HRmodelBrain[2,1], digits=3), format(HRmodelBrain[2,2], digits=3), format(HRmodelBrain[2,3], digits=3))

supp4[33,]<-c('LEUK', 'Intermediate',  format(HRmodelLeuk[1,1], digits=3), format(HRmodelLeuk[1,2], digits=3), format(HRmodelLeuk[1,3], digits=3))
supp4[34,]<-c('LEUK',  'Long', format(HRmodelLeuk[2,1], digits=3), format(HRmodelLeuk[2,2], digits=3), format(HRmodelLeuk[2,3], digits=3))

supp4$Cancer_type=factor(supp4$Cancer_type, levels=c("BRAI", "BREA", "CERV", "COL","GCT","GON", "HL","HN","LEUK", "LUNG", "KID",  "MEL", "NHL", "OS", "STOM", "STS", "THY"))
supp4$HR<-as.numeric(supp4$HR)
supp4$lowCI<-as.numeric(supp4$lowCI)
supp4$UpperCI<-as.numeric(supp4$UpperCI)

```

# Figure 4
```{r}
#GCD figure

ggplot(supp4,aes(x = `GCD category`, y =`HR`, color=`GCD category`)) +
  geom_point(size = 1)+
  scale_color_manual(values=c("blue", "green"), name="", labels=c("Intermediate  (>12.5 to <50 miles) vs. Short (<=12.5 miles)","Long (>=50 miles) vs. Short (<=12.5 miles)"))+
  ylim(0.5,4.5) +
   coord_flip() +
  geom_errorbar(aes(ymax = lowCI, ymin = UpperCI), width = 0.1)+
  geom_hline(yintercept = 1, color="black", linetype = 1 ) +

theme(axis.title.y=element_blank(),
       axis.ticks.y=element_blank(),
       axis.text.y=element_blank(),
      axis.title.x = element_text(face="bold"),
      axis.text.x = element_text(face="bold"),
      panel.background=element_blank(),
       axis.line.x=element_line(size = 0.5, colour = "black", linetype=1),
      strip.background=element_rect(), strip.text = element_text(size=8, face="bold", angle=180), legend.position = "bottom", legend.text=element_text(face="bold"), legend.text.align = 0) +

 facet_wrap(~`Cancer_type`, ncol=2, strip.position = "left", dir="v", labeller = labeller(`Cancer type` = label_wrap_gen(10)))+
  ylab("HR (95%CI)") +
  xlab("Cancer type")
ggsave("Figure4.pdf")

wb<-createWorkbook()
addWorksheet(wb, sheetName="Supplementary Table 2")
writeData(wb, sheet="Supplementary Table 2", x=supp2)
addWorksheet(wb, sheetName="Supplementary Table 3")
writeData(wb, sheet="Supplementary Table 3", x=supp3)
addWorksheet(wb, sheetName="Supplementary Table 4")
writeData(wb, sheet="Supplementary Table 4", x=supp4)
saveWorkbook(wb, "Supplementary Tables.xlsx", overwrite=TRUE)
```
# Supplementary Table 5
```{r}
table1(~cantype|GCD*as.factor(dead), analytic_dt_lb)

```




