---
#R VERSION: 3.5.0
#PROJECT: Manuscript entitled "Impact of geographic factors on AYA stage at diagnosis"
#PURPOSE: Code to generate results in paper
#AUTHORS: Kim Johnson 
#CREATED: August 5, 2019
#LATEST:  "`r format(Sys.time(), '%d %B, %Y')`" 
#NOTES:   
editor_options: 
  chunk_output_type: inline
---
#Load packages and open libraries used for the analysis
```{r setup, include=FALSE}
#install.packages("survminer") #for pairwise diffs
#install.packages("survival")  #for calculating KM values
#install.packages("ggplot") #for plotting KM curve
#install.packages("table1")
#install.packages("expss") # for variable labelling
#install.packages("odds.n.ends")
#install.packages("lmtest")
#install.packages("gridExtra")
#install.packages("openxlsx")
#install.packages("dplyr")
#install.packages("DiagrammeR")
#install.packages("olsrr")

library(olsrr)
library(survminer) 
library(survival)
library(ggplot2) 
library(table1)
library(openxlsx)
library(lmtest)
library(odds.n.ends)
library(expss)
library(gridExtra)
library(lmtest)
library(dplyr)
library(DiagrammeR)
```

#Load data from Box
```{r}
#original location
#AYAcancer_type <- read.csv("/Users/kijohnson/Box/From Box/NCDB  (PUF) 2015.1198/NCDB 2015.1198 (all files)/NCDB1198ALLv2_cancertype.csv") #cancer case data with AYA coding
AYA<-read.csv("NCDB1198ALLv2_cancertype.csv")
```
#Data management
```{r}
#variables needed: age group, RUCC codes, Urban/rural 2013, sex, race, insurance, income, percent w/o highschool degree, cancer type, distance from cancer center

#make age groups
AYA$Age_cat[AYA$AGE>=15 & AYA$AGE<20] <- 0
AYA$Age_cat[AYA$AGE>=20 & AYA$AGE<25] <- 1
AYA$Age_cat[AYA$AGE>=25 & AYA$AGE<30] <- 2
AYA$Age_cat[AYA$AGE>=30 & AYA$AGE<35] <- 3
AYA$Age_cat[AYA$AGE>=35] <- 4
AYA$Age_cat<-factor(AYA$Age_cat,levels=c(0:4),labels=c("15-19","20-24","25-29","30-34", "35-39"))
table(AYA$Age_cat, useNA="always")

#make age groups2
AYA$Age_cat2[AYA$AGE>=15 & AYA$AGE<20] <- 0
AYA$Age_cat2[AYA$AGE>=20 & AYA$AGE<30] <- 1
AYA$Age_cat2[AYA$AGE>=30 & AYA$AGE<40] <- 2
AYA$Age_cat2<-factor(AYA$Age_cat2,levels=c(0:2),labels=c("15-19","20-29","30-39"))
table(AYA$Age_cat2, useNA="always")

#recode sex
AYA$SEX[AYA$SEX==1] <- 1 #males coded as 1
AYA$SEX[AYA$SEX==2] <- 0 #females coded as 0
AYA$SEX<- factor(AYA$SEX,levels=c(1:0),labels=c("Male","Female"))
table(AYA$SEX, useNA="always")

#recode race/ethnicity
#Code for White 1
#Code for Black 2
#Code for Other >=3 and !=99 (Unknown)
AYA$RACE[AYA$RACE==1 & AYA$SPANISH_HISPANIC_ORIGIN==0]<-0
AYA$RACE[AYA$RACE==2 & AYA$SPANISH_HISPANIC_ORIGIN==0]<-1
AYA$RACE[AYA$RACE>=3 & AYA$RACE<99 & AYA$SPANISH_HISPANIC_ORIGIN==0]<-2
AYA$RACE[AYA$SPANISH_HISPANIC_ORIGIN>0 &  AYA$SPANISH_HISPANIC_ORIGIN<9]<-3
AYA$RACE<- factor(AYA$RACE,levels=c(0:3),labels=c("Non-Hispanic White","Non-Hispanic Black","Non-Hispanic Other", "Hispanic"))
table(AYA$RACE, useNA="always")

#label primary payer
AYA$insurance<-factor(AYA$INSURANCE_STATUS, levels=c(0:4), labels=c("Not Insured", "Private Insurance/Managed Care", "Medicaid", "Medicare", "Other Government"))
table(AYA$insurance, useNA="always")

#label analytic stage
AYA$stage<-factor(AYA$ANALYTIC_STAGE_GROUP, levels=c(0,1,2,3,4,5,8,9), labels=c("Stage 0", "Stage I", "Stage II", "Stage III", "Stage IV", "Occult (lung only)", "AJCC Staging Not Applicable", "AJCC Staging Unknown"))
table(AYA$stage, useNA="always")

#create early and late stage group (exclude stage 0 and Occult (lung only))
AYA$stage_binary[AYA$stage=="Stage I"|AYA$stage=="Stage II"]<-0
AYA$stage_binary[AYA$stage=="Stage III"|AYA$stage=="Stage IV"]<-1
AYA$stage_binary<-factor(AYA$stage_binary, levels=c(0,1), labels=c("Early", "Late"))
table(AYA$stage_binary, useNA="always")

#education quartiles (This measure of educational attainment for each patient's area of residence is estimated by matching the zip code of the patient recorded at the time of diagnosis against files derived from the 2012 American Community Survey data, spanning years 2008-2012. 
AYA$educ[AYA$NO_HSD_QUAR_12==1]<-0
AYA$educ[AYA$NO_HSD_QUAR_12==2]<-1
AYA$educ[AYA$NO_HSD_QUAR_12==3]<-2
AYA$educ[AYA$NO_HSD_QUAR_12==4]<-3
AYA$educ<-factor(AYA$educ, levels=c(0:3), labels=c("21% or more", "13%-20.9%", "7%-12.9%", "Less than 7%"))
table(AYA$educ, useNA="always")


#income quartiles 2008-2012 (Median household income for each patient's area of residence is estimated by matching the zip code of the patient recorded at the time of diagnosis against files derived from the 2012 American Community Survey data, spanning years 2008-2012 and adjusted for 2012 inflation.)
AYA$income[AYA$MED_INC_QUAR_12==1]<-0
AYA$income[AYA$MED_INC_QUAR_12==2]<-1
AYA$income[AYA$MED_INC_QUAR_12==3]<-2
AYA$income[AYA$MED_INC_QUAR_12==4]<-3
AYA$income<-factor(AYA$income, levels=c(0:3), labels=c("Less than $38,000", "$38,000-$47,999", "$48,000-$62,999", "$63,000+"))
table(AYA$income, useNA="always")

#Rural/Urban
AYA$RUCC[AYA$UR_CD_13==1]<-0
AYA$RUCC[AYA$UR_CD_13==2]<-1
AYA$RUCC[AYA$UR_CD_13==3]<-2
AYA$RUCC[AYA$UR_CD_13==4]<-3
AYA$RUCC[AYA$UR_CD_13==5]<-4
AYA$RUCC[AYA$UR_CD_13==6]<-5
AYA$RUCC[AYA$UR_CD_13==7]<-6
AYA$RUCC[AYA$UR_CD_13==8]<-7
AYA$RUCC[AYA$UR_CD_13==9]<-8
AYA$RUCC<-factor(AYA$RUCC, levels=c(0:8), labels=c("Counties in metro areas of ≥ 1 million", "Counties in metro areas of 250,000 to 1 million", "Counties in metro areas of <250,000", "Urban population of ≥20,000, adjacent to a metro area", "Urban population of ≥20,000, not adjacent to a metro area", "Urban population of 2,500 to 19,999, adjacent to a metro area", "Urban population of 2,500 to 19,999, not adjacent to a metro area", "Completely rural or ≤2,500 urban population, adjacent to a metro area", "Completely rural or ≤2,500 urban population, not adjacent to a metro area"))
table(AYA$RUCC, useNA="always") #no missing data

#divide into metro, nonmetrourban, and rural
AYA$RUCC3[AYA$RUCC=="Counties in metro areas of ≥ 1 million"|AYA$RUCC=="Counties in metro areas of 250,000 to 1 million"|AYA$RUCC=="Counties in metro areas of <250,000"]<-0

AYA$RUCC3[AYA$RUCC=="Urban population of ≥20,000, adjacent to a metro area"|AYA$RUCC=="Urban population of ≥20,000, not adjacent to a metro area"|AYA$RUCC=="Urban population of 2,500 to 19,999, adjacent to a metro area"|AYA$RUCC=="Urban population of 2,500 to 19,999, not adjacent to a metro area"]<-1

AYA$RUCC3[AYA$RUCC=="Completely rural or ≤2,500 urban population, adjacent to a metro area"|AYA$RUCC=="Completely rural or ≤2,500 urban population, not adjacent to a metro area"]<-2
AYA$RUCC3<-factor(AYA$RUCC3, levels=c(0:2), labels=c("Metro", "Urban", "Rural"))

table(AYA$RUCC3, AYA$RUCC, useNA="ifany")
table(AYA$RUCC3, useNA="ifany")

#greater circle distance
#Justifcation from PMID: 24516014  "Three patient groups were created on the basis of travel distance: short ( 12.5 miles); intermediate (12.5 to 49.9 miles); long ( 50 miles). We selected 50 miles as our long-distance benchmark on the basis of work by Onega et al.9"
AYA$GCD[AYA$CROWFLY<=12.5]<-0
AYA$GCD[AYA$CROWFLY>12.5 & AYA$CROWFLY<=49.9]<-1
AYA$GCD[AYA$CROWFLY>=50]<-2
AYA$GCD<-factor(AYA$GCD, levels=c(0:2), labels=c("Short", "Intermediate", "Long"))
table(AYA$GCD)

#recode vital status
AYA$dead[AYA$PUF_VITAL_STATUS==1]<-0
AYA$dead[AYA$PUF_VITAL_STATUS==0]<-1
table(AYA$dead)

#person months
summary(AYA$DX_LASTCONTACT_DEATH_MONTHS)

#cancer type coding according to https://seer.cancer.gov/ayarecode/aya-who2008.html
AYA$cantype[(AYA$PRIMARY_SITE %in% c(0:809)& AYA$HISTOLOGY%in%c(9826, 9835:9836,9840, 9861, 9865:9867, 9869, 9871:9874, 9891, 9895:9898, 9910:9911, 9920,9863, 9875:9876, 9945:9946,9742, 9800:9801, 9805:9809, 9820, 9831:9834, 9860, 9870, 9930:9931, 9940, 9948, 9963:9964))|
(AYA$PRIMARY_SITE %in% c(420:421, 424)& AYA$HISTOLOGY%in%c(9811:9818, 9837))|
(AYA$PRIMARY_SITE %in% c(420:421, 424)& AYA$HISTOLOGY%in%c(9823, 9827))]<-
"1.0 Leukemias"

AYA$cantype[(AYA$PRIMARY_SITE %in% c(0:809)& AYA$HISTOLOGY%in%c(9590:9591, 9596:9597, 9670:9671, 9673, 9675, 9678:9680, 9684, 9687:9691, 9695, 9698:9702, 9705, 9708:9709, 9712, 9714, 9716:9719, 9725:9729, 9735, 9737:9738, 9650:9655, 9659, 9661:9665, 9667))|
(AYA$PRIMARY_SITE %in% c(0:419, 422:423, 425:809)& AYA$HISTOLOGY%in%c( 9811:9818, 9823, 9827, 9837))]<-
"2.1 Non-Hodgkin lymphoma"

AYA$cantype[AYA$PRIMARY_SITE %in% c(0:809)& AYA$HISTOLOGY%in%c(9650:9655, 9659, 9661:9665, 9667)]<-
"2.2 Hodgkin lymphoma"

AYA$cantype[(AYA$PRIMARY_SITE %in% c(0:809)& AYA$HISTOLOGY%in%c(9410:9411, 9420:9421, 9424,9401, 9440:9442, 9400, 9381:9384, 9423, 9430, 9450:9451, 9460,	9391:9394))|
(AYA$PRIMARY_SITE %in% c(723)& AYA$HISTOLOGY %in% c(9380))|
(AYA$PRIMARY_SITE %in% c(0:722, 724:809) & AYA$HISTOLOGY %in% c(9380))|
  
(AYA$PRIMARY_SITE %in% c(716) & AYA$HISTOLOGY %in% c(9470:9474))|
(AYA$PRIMARY_SITE %in% c(0:715, 717:809) & AYA$HISTOLOGY %in% c(9470:9474))|
(AYA$PRIMARY_SITE %in% c(0:699, 730:750, 754:809) & AYA$HISTOLOGY %in% c(9350:9351, 9360:9362, 9390, 9480, 9530:9535, 9537:9539, 9541, 9550, 9562, 9570))|
(AYA$PRIMARY_SITE %in% c(700:729, 751:753) & AYA$HISTOLOGY %in% c(9161, 9361:9362, 9390, 9530:9531, 9535, 9538, 9540, 9560, 9571))|
(AYA$PRIMARY_SITE %in% c(700) & AYA$HISTOLOGY %in% c(9532, 9534, 9537, 9539))|
(AYA$PRIMARY_SITE %in% c(753) & AYA$HISTOLOGY %in% c(9360))|
(AYA$PRIMARY_SITE %in% c(711) & AYA$HISTOLOGY %in% c(9480, 9539))|
(AYA$PRIMARY_SITE %in% c(713) & AYA$HISTOLOGY %in% c(9480, 9533))|
(AYA$PRIMARY_SITE %in% c(719) & AYA$HISTOLOGY %in% c(9350))|
(AYA$PRIMARY_SITE %in% c(714,717) & AYA$HISTOLOGY %in% c(9480))|
(AYA$PRIMARY_SITE %in% c(709) & AYA$HISTOLOGY %in% c(9539))|
(AYA$PRIMARY_SITE %in% c(700:729, 751:753) & AYA$HISTOLOGY %in% c(8000:8005))]<-
"3.0 CNS and Other Intracranial and Intraspinal Neoplasms (all behaviors)"

AYA$cantype[(AYA$PRIMARY_SITE %in% c(569, 620:629)& AYA$HISTOLOGY%in%c(9060:9065, 9070:9073, 9080:9085, 9090:9091, 9100:9102, 9105) & AYA$BEHAVIOR==3)|
(AYA$PRIMARY_SITE %in% c(700:729, 751:753)& AYA$HISTOLOGY%in%c(9060:9065, 9070:9073, 9080:9085, 9090:9091, 9100:9102, 9105) & AYA$BEHAVIOR %in% c(0,1,3))|
(AYA$PRIMARY_SITE %in% c(0:568, 570:619, 630:699, 730:750, 754:809)& AYA$HISTOLOGY %in%  c(9060:9065, 9070:9073, 9080:9085, 9090:9091, 9100:9102, 9104:9105) & AYA$BEHAVIOR==3)]<-
"6.1 Germ cell and trophoblastic neoplasms of gonads"

AYA$cantype[AYA$PRIMARY_SITE %in% c(0:809) & AYA$HISTOLOGY %in% c(8720:8723, 8726, 8728, 8730, 8740:8746, 8761, 8770:8774, 8780) & AYA$BEHAVIOR==3]<-
"7.1 Melanoma"

AYA$cantype[AYA$PRIMARY_SITE %in% c(739)&AYA$HISTOLOGY%in%c(8010:8589) & AYA$BEHAVIOR==3]<-
"8.1 Thyroid carcinoma"

AYA$cantype[(AYA$PRIMARY_SITE %in% c(110:119) & AYA$HISTOLOGY %in% c(8010:8589) & AYA$BEHAVIOR==3)|
(AYA$PRIMARY_SITE %in% c(0:109, 120:148) & AYA$HISTOLOGY %in% c(8010:8589) & AYA$BEHAVIOR==3)|
 (AYA$PRIMARY_SITE %in% c(300:329,760) & AYA$HISTOLOGY %in% c(8010:8589) & AYA$BEHAVIOR==3)]<-
"8.2 Carcinoma of head and neck"

AYA$cantype[AYA$PRIMARY_SITE %in% c(330:349) &  AYA$HISTOLOGY %in% c(8010:8589) & AYA$BEHAVIOR==3]<-
"8.3 Carcinoma of trachea, bronchus, and lung"

AYA$cantype[AYA$PRIMARY_SITE %in% c(500:509) & AYA$HISTOLOGY %in% c(8010:8589) & AYA$BEHAVIOR==3]<-
"8.4 Carcinoma of breast"

AYA$cantype[AYA$PRIMARY_SITE %in% c(649)&AYA$HISTOLOGY %in% c(8010:8589) & AYA$BEHAVIOR==3]<-
"8.5.1 Carcinoma of kidney"

AYA$cantype[AYA$PRIMARY_SITE %in% c(530, 531, 538,539)&AYA$HISTOLOGY%in%c(8010:8589)]<-
"8.5.4 Carcinoma of cervix"

AYA$cantype[AYA$PRIMARY_SITE %in% c(180:218)&AYA$HISTOLOGY %in% c(8010:8589) & AYA$BEHAVIOR==3]<-
"8.6.1 Carcinoma of colon and rectum"

AYA$cantype[AYA$PRIMARY_SITE %in% c(160:169)&AYA$HISTOLOGY %in% c(8010:8589) & AYA$BEHAVIOR==3]<-
"8.6.2 Carcinoma of stomach"

AYA$cantype[(AYA$PRIMARY_SITE %in% c(569, 620:629) & AYA$HISTOLOGY %in% c(8010:8589) & AYA$BEHAVIOR==3)|
(AYA$PRIMARY_SITE %in% c(0:809) & AYA$HISTOLOGY %in% c(8590:8593) & AYA$BEHAVIOR==3)]<-
"8.5.3 Carcinoma of gonads"

AYA$cantype[(AYA$PRIMARY_SITE %in% c(0:809)&AYA$HISTOLOGY%in%c(9180:9187, 9192:9194,9220:9221, 9230:9231, 9240, 9242:9243, 9260, 9364:9365, 8812, 9250, 9261, 9370:9372))|
(AYA$PRIMARY_SITE %in% c(400:419)& AYA$HISTOLOGY%in% c(8000:8005, 8800:8803, 8805:8806, 9200))]<-
"4.0 Osseous and chondromatous neoplasms"

AYA$cantype[(AYA$PRIMARY_SITE %in% c(0:809) &  AYA$HISTOLOGY %in% c(8810:8811, 8813:8815, 8820:8824, 8830, 8832:8833, 8835:8836, 9252, 8900:8904, 8910, 8912, 8920:8921, 8991,8804, 8825, 8840:8897, 8982:8983, 8990, 9040:9044, 9120:9139, 9141:9150, 9170, 9251, 9561, 9580:9581) & AYA$BEHAVIOR==3)|
(AYA$PRIMARY_SITE %in% c(0:699, 730:750, 754:809) & AYA$HISTOLOGY %in%c (9540, 9560, 9571) & AYA$BEHAVIOR==3)|
(AYA$PRIMARY_SITE %in% c(0:809) & AYA$HISTOLOGY %in% c(9140) & AYA$BEHAVIOR==3)|
(AYA$PRIMARY_SITE %in% c(0:399, 420:809) & AYA$HISTOLOGY %in% c(8800:8803, 8805:8806) & AYA$BEHAVIOR==3)]<-
"5.0 Soft Tissue Sarcomas"

#Apply variable labels
AYA<-apply_labels(AYA, insurance="Insurance", Age_cat="Age category (years)", SEX="Sex", RACE="Race", educ="Education", income="Income", stage="Stage at diagnosis", cantype="Cancer Type")
```

# Exclusions
```{r}
#Exclude individuals <15 and with years of dx outside of 2010-2014
AYA2<-AYA[which(AYA$AGE >=15 & AYA$YEAR_OF_DIAGNOSIS>=2010 & AYA$YEAR_OF_DIAGNOSIS<=2014),]
dim(AYA2)

#Exclude individuals seen at more that one facility
AYA2<-AYA2[which(AYA2$PUF_MULT_SOURCE==0),]
dim(AYA2)

#Code to determine facility exclusions and exclude facilities that didn't report all years
tab<-table(AYA2$PUF_FACILITY_ID, AYA2$YEAR_OF_DIAGNOSIS)
tab2<-as.data.frame.matrix(tab)
colnames(tab2)<-c("yr10","yr11", "yr12", "yr13", "yr14") #R doesn't like numerical column names
tab2<-cbind(facility=rownames(tab2), tab2) #turn rows into a column (one column)
rownames(tab2)<-NULL #remove row names from first 'column'

#Code to exclude facilities not reporting all years
tab3<-subset(tab2, yr10==0|yr11==0|yr12==0|yr13==0|yr14==0)
facility<-as.vector(tab3$facility)
facility
typeof(facility)

#Remove anyone with a facility vector value 
exclude<-AYA2[!(AYA2$PUF_FACILITY_ID%in%facility),]
dim(AYA2)

#Exclude second cancers and those with cancer types recorded as other
exclude<-exclude[which(exclude$SEQUENCE_NUMBER==0),] 
exclude<-exclude[which(!is.na(exclude$cantype)),] #use for leukemia and brain below'
dim(exclude)

#Exclude leukemias and brain that are not staged 
exclude2<- subset(exclude, cantype!="1.0 Leukemias" & cantype!="3.0 CNS and Other Intracranial and Intraspinal Neoplasms (all behaviors)")
dim(exclude2)

table(exclude2$ANALYTIC_STAGE_GROUP)

#Exclude "Stage 0", "Occult (lung only)", "AJCC Staging Not Applicable"
analytic_dt<-subset(exclude2, ANALYTIC_STAGE_GROUP !=0 & ANALYTIC_STAGE_GROUP !=5 & ANALYTIC_STAGE_GROUP !=8)
dim(analytic_dt)
```

#Second set of exclusions of missing data for complete dataset
```{r}
#Remove missing values from dataset for stage analysis
analytic_dt_v <- analytic_dt[which(analytic_dt$RACE!="NA"),]
analytic_dt_v <- analytic_dt_v[which(analytic_dt_v$insurance!="NA"),]
analytic_dt_v <- analytic_dt_v[which(analytic_dt_v$stage_binary!="NA"),]
analytic_dt_v <- analytic_dt_v[which(analytic_dt_v$educ!="NA"),]
analytic_dt_v <- analytic_dt_v[which(analytic_dt_v$income!="NA"),]
analytic_dt_v <- analytic_dt_v[which(analytic_dt_v$RUCC!="NA"),]
analytic_dt_v <- analytic_dt_v[which(analytic_dt_v$RUCC3!="NA"),]
analytic_dt_v <- analytic_dt_v[which(analytic_dt_v$GCD!="NA"),]
analytic_dt_v <- analytic_dt_v[which(analytic_dt_v$dead!="NA"),]
analytic_dt_v <- analytic_dt_v[which(analytic_dt_v$DX_LASTCONTACT_DEATH_MONTHS!="NA"),]
dim(analytic_dt_v)

#Exclude for leukemia and brain for survival analysis
analytic_dt_lb <- exclude[which(exclude$RACE!="NA"),]
analytic_dt_lb <- analytic_dt_lb[which(analytic_dt_lb$insurance!="NA"),]
analytic_dt_lb <- analytic_dt_lb[which(analytic_dt_lb$educ!="NA"),]
analytic_dt_lb <- analytic_dt_lb[which(analytic_dt_lb$income!="NA"),]
analytic_dt_lb <- analytic_dt_lb[which(analytic_dt_lb$RUCC!="NA"),]
analytic_dt_lb <- analytic_dt_lb[which(analytic_dt_lb$RUCC3!="NA"),]
analytic_dt_lb <- analytic_dt_lb[which(analytic_dt_lb$GCD!="NA"),]
analytic_dt_lb <- analytic_dt_lb[which(analytic_dt_lb$dead!="NA"),]
analytic_dt_lb <- analytic_dt_lb[which(analytic_dt_lb$DX_LASTCONTACT_DEATH_MONTHS!="NA"),]
dim(analytic_dt_lb)
```

# Figure 1: flowchart for stage
```{r}
grViz("digraph flowchart {

      # node definitions with substituted label text
      node [fontname = Helvetica, shape = rectangle, fontsize=10]        
      tab1 [label = '@@1']
      tab2 [label = '@@2']
      tab3 [label = '@@3']
      tab4 [label = '@@4']
      tab5 [label = '@@5']
      tab6 [label = '@@6']
      tab7 [label = '@@7']
      tab8 [label = '@@8']
      tab9 [label = '@@9']
      # edge definitions with the node IDs
      tab1 -> tab2 -> tab3 -> tab4 -> tab5;
      tab5 -> tab6 -> tab7 -> tab8;
      tab5 -> tab9;
      }
      [1]: 'Records received from NCDB for diagnoses in 0-39 2004-2015 n=780,847'
      [2]: 'Excluding 471,307 individuals diagnosed before age 15 and before 2010 n=309,540'
      [3]: 'Excluding 46,010 individuals seen at more than one facility n=263,530'
      [4]: 'Excluding 6022 individuals seen at facilities not reporting in all years n=257,508'
      [5]: 'Excluding 65,500 individuals with second cancers and \\n those with cancer types not classified according to the \\n  AYA Site Recode/WHO 2008 Definition n=192,008'
      [6]: 'Excluding 19,825 individuals with leukemia and \\n  brain tumors n=172,183'
      [7]: 'Excluding 5400 individuals not malignant, stage 0, \\n Occult (lung only), and AJCC staging not applicable n=166,783'
      [8]: 'Excluding 20,365 individuals with missing data \\n on variables used in the stage analysis n=146,418'
      [9]: 'Excluding 13,320 individuals with missing data on variables \\n used in the survival analysis n=178,688'
      ")
```
# Check association between rural/urban and GCD variables
```{r}
table(analytic_dt_v$RUCC, analytic_dt_v$GCD)
chisq.test(table(analytic_dt_v$RUCC, analytic_dt_v$GCD))
table1(~RUCC|GCD,analytic_dt_v)
```

# Table 1: Descriptive characteristics for stage dataset
```{r}
analytic_dt_v$stage<-droplevels(analytic_dt_v$stage)
label(analytic_dt_v$stage)<-"Stage at diagnosis"
label(analytic_dt_v$stage_binary)<-"Stage at diagnosis (early vs. late)"
label(analytic_dt_v$insurance)<-"Insurance at diagnosis or first treatment"
label(analytic_dt_v$educ)<-"Zip-code median percent no high school degree quartile 2008-2012"
label(analytic_dt_v$income)<-"Zip-code median income quartile 2008-2012"
label(analytic_dt_v$GCD)<-"Distance from reporting hospital"

table1(~SEX + Age_cat + RACE + insurance + income + educ + GCD + stage_binary + cantype |RUCC3, rowlabelhead="Variable", droplevels=TRUE, data=analytic_dt_v)

#check cervical cancer cases against GCD variable in response to reviewer's request.
table1(~SEX + Age_cat + RACE + insurance + income + educ + GCD + stage_binary + cantype |GCD, rowlabelhead="Variable", droplevels=TRUE, data=analytic_dt_v)

cervical<-analytic_dt_v[which(analytic_dt_v$cantype=="8.5.4 Carcinoma of cervix"),]
prop.table(table(cervical$stage_binary, cervical$GCD),2)
```
#Supplementary Table 2: Descriptive characteristics for overall survival dataset
```{r}
analytic_dt_lb$stage<-droplevels(analytic_dt_lb$stage)
label(analytic_dt_lb$stage)<-"Stage at diagnosis"
label(analytic_dt_lb$stage_binary)<-"Stage at diagnosis (early vs. late)"
label(analytic_dt_lb$insurance)<-"Insurance at diagnosis or first treatment"
label(analytic_dt_lb$educ)<-"Zip-code median percent no high school degree quartile 2008-2012"
label(analytic_dt_lb$income)<-"Zip-code median income quartile 2008-2012"
label(analytic_dt_lb$GCD)<-"Distance from reporting hospital"
table1(~SEX + Age_cat + RACE + insurance  + income + educ + GCD + stage_binary + cantype|RUCC3, droplevels=TRUE, data=analytic_dt_lb)

```
#Table 2: Unadjusted regression models for stage (Rural Urban distance)
```{r}
#RUCC3 category
RUCC3.1<-glm(stage_binary ~ RUCC3, family = "binomial", data = analytic_dt_v)
summary(RUCC3.1)
odds.n.ends(RUCC3.1)
nobs(RUCC3.1)
addmargins(table(analytic_dt_v$stage_binary, analytic_dt_v$RUCC3))

#GCD
GCD.1<-glm(stage_binary ~ GCD, family = "binomial", data = analytic_dt_v)
summary(GCD.1)
odds.n.ends(GCD.1)
nobs(GCD.1)
addmargins(table(analytic_dt_v$stage_binary, analytic_dt_v$GCD))
```

# Table 2: Adjusted regression models for stage (Rural Urban distance)
```{r}
#Adjusted for confounders determined from DAG
RUCC3.1a<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v)
odds.n.ends(RUCC3.1a)

#Adjusted for confounders determined from DAG 
RUCC3.2a<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ + income + insurance, family = "binomial", data = analytic_dt_v)
odds.n.ends(RUCC3.2a)

#Adjusted for confounders determined from DAG 
RUCC3.3a<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ + income +GCD,  family = "binomial", data = analytic_dt_v)
odds.n.ends(RUCC3.3a)

#GCD
#Adjusted for confounders determined from DAG 
GCD.1a<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ + income + insurance, family = "binomial", data = analytic_dt_v)
odds.n.ends(GCD.1a)

#Adjusted for confounders determined from DAG (minimal set-race, education, age, sex) plus income and insurance in response to reviewer comments
GCD.2a<-glm(stage_binary ~ GCD + RACE + AGE + educ+ SEX + income +insurance, family = "binomial", data = analytic_dt_v)
odds.n.ends(GCD.2a)

#Adjusted for confounders determined from DAG (minimal set-race, education, age, sex) + RUCC3
GCD.3a<-glm(stage_binary ~ GCD + RACE + AGE + SEX +  educ + income + RUCC3, family = "binomial", data = analytic_dt_v)
odds.n.ends(GCD.3a)

#Interaction model Adjusted for confounders determined from DAG (minimal set-race, education, age, sex) + RUCC3
GCD.4a<-glm(stage_binary ~ GCD + RACE + AGE + SEX +  educ + income + RUCC3 + GCD*RUCC3, family = "binomial", data = analytic_dt_v)
odds.n.ends(GCD.4a)

lrtest(GCD.3a, GCD.4a )

#Model with crowfly as a linear term in response to reviewer comment
GCD.5a<-glm(stage_binary ~ CROWFLY + RACE + AGE + educ+ SEX, family = "binomial", data = analytic_dt_v)
odds.n.ends(GCD.5a)

#Box Tidwell test for linearity
analytic_dt_v$cf.times.logcf = analytic_dt_v$CROWFLY * log(analytic_dt_v$CROWFLY)
GCD.6a<-glm(stage_binary ~ CROWFLY + RACE + AGE + educ+ SEX + cf.times.logcf, family = "binomial", data = analytic_dt_v)
summary(GCD.6a)
odds.n.ends(GCD.6a)

#create deciles and run deciles as the exposure
analytic_dt_v$CFdecile<-ntile(analytic_dt_v$CROWFLY,10)
table(analytic_dt_v$CFdecile)

GCD.7a<-glm(stage_binary ~ as.factor(CFdecile) + RACE + AGE + educ+ SEX +  income, family = "binomial", data = analytic_dt_v)
odds.n.ends(GCD.7a)

summary(analytic_dt_v[which(analytic_dt_v$CFdecile==9),]$CROWFLY)
test<-analytic_dt_v[which(analytic_dt_v$CFdecile==10),]
```

# Modification by sex, race, age category and cancer type of associations between RUCC3 and GCD and stage binary
```{r}
# Effect modification by sex RUCC3
RUCC3.1b<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v)
summary(RUCC3.1b)

RUCC3.2b<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ +income + RUCC3*SEX, family = "binomial", data = analytic_dt_v)
summary(RUCC3.2b)

lrtestEM<-lrtest(RUCC3.1b, RUCC3.2b)
lrtestEM #no interaction by SEX

# Effect modification by RACE RUCC3
RUCC3.3b<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ +income, family = "binomial", data = analytic_dt_v)
summary(RUCC3.3b)

RUCC3.4b<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ +income + RUCC3*RACE, family = "binomial", data = analytic_dt_v)
summary(RUCC3.4b)

lrtestEM<-lrtest(RUCC3.3b, RUCC3.4b)
lrtestEM #no interaction by RACE

# Effect modification by cancer type RUCC3
RUCC3.5b<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ + income + cantype, family = "binomial", data = analytic_dt_v)
summary(RUCC3.5b)

RUCC3.6b<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ  + income + cantype + RUCC3*cantype, family = "binomial", data = analytic_dt_v)
summary(RUCC3.6b)

lrtestEM<-lrtest(RUCC3.5b, RUCC3.6b)
lrtestEM

# Effect modification by age category RUCC3
RUCC3.7b<-glm(stage_binary ~ RUCC3 + RACE + Age_cat2 + SEX + educ +income , family = "binomial", data = analytic_dt_v)
summary(RUCC3.7b)

RUCC3.8b<-glm(stage_binary ~ RUCC3 + RACE + Age_cat2 + SEX + educ + income + RUCC3*Age_cat2, family = "binomial", data = analytic_dt_v)
summary(RUCC3.8b)

lrtestEM<-lrtest(RUCC3.7b, RUCC3.8b)
lrtestEM

# How different are the estimates?
RUCC3.9b<-glm(stage_binary ~ RUCC3 + RACE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$Age_cat2=="15-19"),])
summary(RUCC3.9b)
odds.n.ends(RUCC3.9b)

RUCC3.10b<-glm(stage_binary ~ RUCC3 + RACE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$Age_cat2=="20-29"),])
summary(RUCC3.10b)
odds.n.ends(RUCC3.10b)

RUCC3.11b<-glm(stage_binary ~ RUCC3 + RACE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$Age_cat2=="30-39"),])
summary(RUCC3.11b)
odds.n.ends(RUCC3.11b)

# Effect modification by sex GCD
GCD.1b<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v)
summary(GCD.1b)

GCD.2b<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ  + income + GCD*SEX, family = "binomial", data = analytic_dt_v)
summary(GCD.2b)

lrtestEM<-lrtest(GCD.1b, GCD.2b)
lrtestEM #interaction by SEX 0.01

# How different are the estimates?
GCD.3b<-glm(stage_binary ~ GCD + RACE + AGE + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$SEX=="Male"),])
summary(GCD.3b)
odds.n.ends(GCD.3b) #males
GCD.4b<-exp(cbind(OR = coef(GCD.3b), confint(GCD.3b))) #calculate ORs and 95% CIs
  GCD.4b #print ORs and 95% CIs

GCD.5b<-glm(stage_binary ~ GCD + RACE + AGE + educ +income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$SEX=="Female"),])
summary(GCD.5b)
odds.n.ends(GCD.5b) #females
GCD.6b<-exp(cbind(OR = coef(GCD.5b), confint(GCD.5b))) #calculate ORs and 95% CIs
  GCD.6b #print ORs and 95% CIs

# Effect modification by RACE GCD
GCD.7b<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v)
summary(GCD.7b)

GCD.8b<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ + income + GCD*RACE, family = "binomial", data = analytic_dt_v)
summary(GCD.8b)

lrtestEM<-lrtest(GCD.7b, GCD.8b)
lrtestEM #no interaction by RACE (p=0.07)

# How different are the estimates?
GCD.9b<-glm(stage_binary ~ GCD + SEX + AGE + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$RACE=="Non-Hispanic White"),])
summary(GCD.9b)
odds.n.ends(GCD.9b) #White

GCD.10b<-glm(stage_binary ~ GCD + SEX + AGE + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$RACE=="Non-Hispanic Black"),])
summary(GCD.10b)
odds.n.ends(GCD.10b) #Black

GCD.11b<-glm(stage_binary ~ GCD + SEX + AGE + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$RACE=="Hispanic"),])
summary(GCD.11b)
odds.n.ends(GCD.11b) #Hispanic

GCD.12b<-glm(stage_binary ~ GCD + SEX + AGE + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$RACE=="Non-Hispanic Other"),])
summary(GCD.12b)
odds.n.ends(GCD.12b) #Non-Hispanic Other

# Effect modification by cancer type GCD
GCD.13b<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ + income + cantype, family = "binomial", data = analytic_dt_v)

GCD.14b<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ +income + cantype + GCD*cantype, family = "binomial", data = analytic_dt_v)

lrtestEM<-lrtest(GCD.13b, GCD.14b)
lrtestEM

# Effect modification by age category GCD
GCD.15b<-glm(stage_binary ~ GCD + RACE + Age_cat2 + SEX +  educ + income, family = "binomial", data = analytic_dt_v)
summary(GCD.15b)

GCD.16b<-glm(stage_binary ~ GCD + RACE + Age_cat2 + SEX + educ + income + GCD*Age_cat2, family = "binomial", data = analytic_dt_v)
summary(GCD.16b)

lrtestEM<-lrtest(GCD.15b, GCD.16b)
lrtestEM

# How different are the estimates?
GCD.17b<-glm(stage_binary ~ GCD + RACE + SEX + educ +income , family = "binomial", data = analytic_dt_v[which(analytic_dt_v$Age_cat2=="15-19"),])
summary(GCD.17b)
odds.n.ends(GCD.17b)
GCD.18b<-exp(cbind(OR = coef(GCD.17b), confint(GCD.17b))) #calculate ORs and 95% CIs
 GCD.18b #print ORs and 95% CIs

GCD.19b<-glm(stage_binary ~ GCD + RACE + SEX + educ +income , family = "binomial", data = analytic_dt_v[which(analytic_dt_v$Age_cat2=="20-29"),])
summary(GCD.19b)
odds.n.ends(GCD.19b)
GCD.20b<-exp(cbind(OR = coef(GCD.19b), confint(GCD.19b))) #calculate ORs and 95% CIs
  GCD.20b #print ORs and 95% CIs
  
GCD.21b<-glm(stage_binary ~ GCD+ RACE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$Age_cat2=="30-39"),])
summary(GCD.21b)
odds.n.ends(GCD.21b)
GCD.22b<-exp(cbind(OR = coef(GCD.21b), confint(GCD.21b))) #calculate ORs and 95% CIs
  GCD.22b #print ORs and 95% CIs
```

# OR by cancer types for RUCC3 and GCD
```{r}
# 2.1 Non-Hodgkin lymphoma
RUCC3.1c<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="2.1 Non-Hodgkin lymphoma"),])
summary(RUCC3.1c)

RUCC3.2c<-exp(cbind(OR = coef(RUCC3.1c), confint(RUCC3.1c))) #calculate ORs and 95% CIs
  RUCC3.2c #print ORs and 95% CIs

#GCD
GCD.1c<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="2.1 Non-Hodgkin lymphoma"),])
summary(GCD.1c)

GCD.2c<-exp(cbind(OR = coef(GCD.1c), confint(GCD.1c))) #calculate ORs and 95% CIs
  GCD.2c #print ORs and 95% CIs

#**********************************************
#2.2 Hodgkin lymphoma
RUCC3.3c<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="2.2 Hodgkin lymphoma"),])

RUCC3.4c<-exp(cbind(OR = coef(RUCC3.3c), confint(RUCC3.3c))) #calculate ORs and 95% CIs
  RUCC3.3c #print ORs and 95% CIs
  
#GCD
GCD.3c<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="2.2 Hodgkin lymphoma"),])

GCD.4c<-exp(cbind(OR = coef(GCD.3c), confint(GCD.3c))) #calculate ORs and 95% CIs
 GCD.4c #print ORs and 95% CIs
#**********************************************
#4.0 Osseous and chondromatous neoplasms
RUCC3.5c<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="4.0 Osseous and chondromatous neoplasms"),])

RUCC3.6c<-exp(cbind(OR = coef(RUCC3.5c), confint(RUCC3.5c))) #calculate ORs and 95% CIs
  RUCC3.6c #print ORs and 95% CIs
  
#GCD
GCD.5c<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="4.0 Osseous and chondromatous neoplasms"),])
summary(GCD.5c)

GCD.6c<-exp(cbind(OR = coef(GCD.5c), confint(GCD.5c))) #calculate ORs and 95% CIs
  GCD.6c #print ORs and 95% CIs

#**********************************************
#5.0 Soft Tissue Sarcomas 
RUCC3.7c<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="5.0 Soft Tissue Sarcomas"),])
summary(RUCC3.7c)

RUCC3.8c<-exp(cbind(OR = coef(RUCC3.7c), confint(RUCC3.7c))) #calculate ORs and 95% CIs
 RUCC3.8c #print ORs and 95% CIs
  
#GCD
GCD.7c<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="5.0 Soft Tissue Sarcomas"),])
summary(GCD.7c)

GCD.8c<-exp(cbind(OR = coef(GCD.7c), confint(GCD.7c))) #calculate ORs and 95% CIs
  GCD.8c #print ORs and 95% CIs

#**********************************************
#6.1 Germ cell and trophoblastic neoplasms of gonads
RUCC3.9c<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="6.1 Germ cell and trophoblastic neoplasms of gonads"),])
summary(RUCC3.9c)

RUCC3.10c<-exp(cbind(OR = coef(RUCC3.9c), confint(RUCC3.9c))) #calculate ORs and 95% CIs
  RUCC3.10c #print ORs and 95% CIs
  
#GCD
GCD.9c<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="6.1 Germ cell and trophoblastic neoplasms of gonads"),])
summary(GCD.9c)

GCD.10c<-exp(cbind(OR = coef(GCD.9c), confint(GCD.9c))) #calculate ORs and 95% CIs
  GCD.10c #print ORs and 95% CIs

#**********************************************
#7.1 Melanoma
RUCC3.11c<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="7.1 Melanoma"),])
summary(RUCC3.11c)

RUCC3.12c<-exp(cbind(OR = coef(RUCC3.11c), confint(RUCC3.11c))) #calculate ORs and 95% CIs
  RUCC3.12c #print ORs and 95% CIs
  
#GCD
GCD.11c<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="7.1 Melanoma"),])
summary(GCD.11c)

GCD.12c<-exp(cbind(OR = coef(GCD.11c), confint(GCD.11c))) #calculate ORs and 95% CIs
  GCD.12c #print ORs and 95% CIs
#**********************************************
#8.1 Thyroid carcinoma
RUCC3.13c<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="8.1 Thyroid carcinoma"),])
summary(RUCC3.13c)

RUCC3.14c<-exp(cbind(OR = coef(RUCC3.13c), confint(RUCC3.13c))) #calculate ORs and 95% CIs
  RUCC3.14c #print ORs and 95% CIs
  
#GCD
GCD.13c<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="8.1 Thyroid carcinoma"),])
summary(GCD.13c)

GCD.14c<-exp(cbind(OR = coef(GCD.13c), confint(GCD.13c))) #calculate ORs and 95% CIs
  GCD.14c #print ORs and 95% CIs

#**********************************************
#8.2 Carcinoma of head and neck
RUCC3.15c<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="8.2 Carcinoma of head and neck"),])
summary(RUCC3.15c)


RUCC3.16c<-exp(cbind(OR = coef(RUCC3.15c), confint(RUCC3.15c))) #calculate ORs and 95% CIs
  RUCC3.16c #print ORs and 95% CIs

#GCD
GCD.15c<-glm(stage_binary ~ GCD + RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="8.2 Carcinoma of head and neck"),])
summary( GCD.15c)

GCD.16c<-exp(cbind(OR = coef(GCD.15c), confint(GCD.15c))) #calculate ORs and 95% CIs
   GCD.16c #print ORs and 95% CIs

#**********************************************
#8.3 Carcinoma of trachea,bronchus, and lung
RUCC3.17c<-glm(stage_binary ~ RUCC3 + RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="8.3 Carcinoma of trachea, bronchus, and lung"),])
summary(RUCC3.17c)

RUCC3.18c<-exp(cbind(OR = coef(RUCC3.17c), confint(RUCC3.17c))) #calculate ORs and 95% CIs
  RUCC3.18c #print ORs and 95% CIs
  
#GCD
GCD.17c<-glm(stage_binary ~ GCD+ RACE + AGE + SEX + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="8.3 Carcinoma of trachea, bronchus, and lung"),])
summary(GCD.17c)

GCD.18c<-exp(cbind(OR = coef(GCD.17c), confint(GCD.17c))) #calculate ORs and 95% CIs
  GCD.18c #print ORs and 95% CIs

#**********************************************
#8.4 Carcinoma of breast
RUCC3.19c<-glm(stage_binary ~ RUCC3 + RACE + AGE  + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="8.4 Carcinoma of breast"),])
summary(RUCC3.19c)

RUCC3.20c<-exp(cbind(OR = coef(RUCC3.19c), confint(RUCC3.19c))) #calculate ORs and 95% CIs
  RUCC3.20c #print ORs and 95% CIs
  
#GCD
GCD.19c<-glm(stage_binary ~ GCD + RACE + AGE  + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="8.4 Carcinoma of breast"),])
summary(GCD.19c)

GCD.20c<-exp(cbind(OR = coef(GCD.19c), confint(GCD.19c))) #calculate ORs and 95% CIs
  GCD.20c #print ORs and 95% CIs

#**********************************************
#8.5.1 Carcinoma of kidney
RUCC3.21c<-glm(stage_binary ~ RUCC3 + RACE + AGE  + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="8.5.1 Carcinoma of kidney"),])
summary(RUCC3.21c)

RUCC3.22c<-exp(cbind(OR = coef(RUCC3.21c), confint(RUCC3.21c))) #calculate ORs and 95% CIs
  RUCC3.22c #print ORs and 95% CIs
  
#GCD
GCD.21c<-glm(stage_binary ~ GCD + RACE + AGE  + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="8.5.1 Carcinoma of kidney"),])
summary(GCD.21c)

GCD.22c<-exp(cbind(OR = coef(GCD.21c), confint(GCD.21c))) #calculate ORs and 95% CIs
   GCD.22c #print ORs and 95% CIs

#**********************************************
#8.5.3 Carcinoma of gonads
RUCC3.23c<-glm(stage_binary ~ RUCC3 + RACE + SEX + AGE  + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="8.5.3 Carcinoma of gonads"),])
summary(RUCC3.23c)

RUCC3.24c<-exp(cbind(OR = coef(RUCC3.23c), confint(RUCC3.23c))) #calculate ORs and 95% CIs
  RUCC3.24c #print ORs and 95% CIs
  
#GCD
GCD.23c<-glm(stage_binary ~ GCD + RACE + SEX + AGE  + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="8.5.3 Carcinoma of gonads"),])
summary(GCD.23c)

GCD.24c<-exp(cbind(OR = coef(GCD.23c), confint(GCD.23c))) #calculate ORs and 95% CIs
  GCD.24c #print ORs and 95% CIs

#**********************************************
#8.5.4 Carcinoma of cervix
RUCC3.25c<-glm(stage_binary ~ RUCC3 + RACE +AGE  + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="8.5.4 Carcinoma of cervix"),])
summary(RUCC3.25c)

RUCC3.26c<-exp(cbind(OR = coef(RUCC3.25c), confint(RUCC3.25c))) #calculate ORs and 95% CIs
  RUCC3.26c #print ORs and 95% CIs
  
#GCD
GCD.25c<-glm(stage_binary ~ GCD + RACE +AGE  + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="8.5.4 Carcinoma of cervix"),])
summary(GCD.25c)

GCD.26c<-exp(cbind(OR = coef(GCD.25c), confint(GCD.25c))) #calculate ORs and 95% CIs
  GCD.26c #print ORs and 95% CIs
  
#add insurance to see if there is possibly residual confounding in response to reviewer request
GCD.27c<-glm(stage_binary ~ GCD + RACE +AGE  + educ + insurance, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="8.5.4 Carcinoma of cervix"),])
summary(GCD.26c)

GCD.28c<-exp(cbind(OR = coef(GCD.27c), confint(GCD.27c))) #calculate ORs and 95% CIs
  GCD.28c #print ORs and 95% CIs

#**********************************************
#8.6.1 Carcinoma of colon and rectum
RUCC3.27c<-glm(stage_binary ~ RUCC3 + RACE + SEX+ AGE + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="8.6.1 Carcinoma of colon and rectum"),])
summary(RUCC3.27c)
RUCC3.28c<-exp(cbind(OR = coef(RUCC3.27c), confint(RUCC3.27c))) #calculate ORs and 95% CIs
  RUCC3.28c #print ORs and 95% CIs

#GCD
GCD.29c<-glm(stage_binary ~ GCD + RACE + SEX+ AGE + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="8.6.1 Carcinoma of colon and rectum"),])
summary(GCD.29c)

GCD.30c<-exp(cbind(OR = coef(GCD.29c), confint(GCD.29c))) #calculate ORs and 95% CIs
  GCD.30c #print ORs and 95% CIs

#**********************************************
#8.6.2 Carcinoma of stomach
RUCC3.29c<-glm(stage_binary ~ RUCC3 + RACE + SEX+ AGE + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="8.6.2 Carcinoma of stomach"),])
summary(RUCC3.29c)

RUCC3.30c<-exp(cbind(OR = coef(RUCC3.29c), confint(RUCC3.29c))) #calculate ORs and 95% CIs
  RUCC3.30c#print ORs and 95% CIs
  
#GCD
GCD.31c<-glm(stage_binary ~ GCD + RACE + SEX+ AGE + educ + income, family = "binomial", data = analytic_dt_v[which(analytic_dt_v$cantype=="8.6.2 Carcinoma of stomach"),])
summary(GCD.31c)

GCD.32c<-exp(cbind(OR = coef(GCD.31c), confint(GCD.31c))) #calculate ORs and 95% CIs
  GCD.32c #print ORs and 95% CIs
```

# Supplementary Table 3
```{r}
#make empty data frame
supp3<-data.frame(matrix(ncol=5, nrow=0))
columns<-c("Cancer type", "Reporting hospital distance category", "OR", "Lower CI", "Upper CI")
colnames(supp3)<-columns

supp3[1,]<-c('NHL',  'Short', 1, "reference", "", digits=3)
supp3[2,]<-c('NHL',  'Intermediate', format(GCD.2c[2,1], digits=3), format(GCD.2c[2,2], digits=3), format(GCD.2c[2,3], digits=3))
supp3[3,]<-c('NHL', 'Long', format(GCD.2c[3,1], digits=3), format(GCD.2c[3,2], digits=3), format(GCD.2c[3,3], digits=3))

supp3[4,]<-c('HL',  'Short', 1, "reference", "", digits=3)
supp3[5,]<-c('HL',  'Intermediate', format(GCD.4c[2,1],digits=3), format(GCD.4c[2,2], digits=3), format(GCD.4c[2,3], digits=3))
supp3[6,]<-c('HL',  'Long', format(GCD.4c[3,1],digits=3), format(GCD.4c[3,2], digits=3), format(GCD.4c[3,3], digits=3))

supp3[7,]<-c('OS',  'Short', 1, "reference", "", digits=3)
supp3[8,]<-c('OS',  'Intermediate', format(GCD.6c[2,1],digits=3), format(GCD.6c[2,2],digits=3), format(GCD.6c[2,3],digits=3))
supp3[9,]<-c('OS',  'Long', format(GCD.6c[3,1],digits=3), format(GCD.6c[3,2],digits=3), format(GCD.6c[3,3], digits=3))

supp3[10,]<-c('STS',  'Short', 1, "reference", "", digits=3)
supp3[11,]<-c('STS',  'Intermediate', format(GCD.8c[2,1],digits=3), format(GCD.8c[2,2],digits=3), format(GCD.8c[2,3],digits=3))
supp3[12,]<-c('STS',  'Long', format(GCD.8c[3,1],digits=3),format(GCD.8c[3,2],digits=3), format(GCD.8c[3,3], digits=3))

supp3[13,]<-c('GCT',  'Short', 1, "reference", "", digits=3)
supp3[14,]<-c('GCT',  'Intermediate', format(GCD.10c[2,1],digits=3), format(GCD.10c[2,2],digits=3), format(GCD.10c[2,3],digits=3))
supp3[15,]<-c('GCT',  'Long', format(GCD.10c[3,1],digits=3), format(GCD.10c[3,2],digits=3), format(GCD.10c[3,3], digits=3))

supp3[16,]<-c('MEL',  'Short', 1, "reference", "", digits=3)
supp3[17,]<-c('MEL',  'Intermediate', format(GCD.12c[2,1],digits=3), format(GCD.12c[2,2],digits=3), format(GCD.12c[2,3],digits=3))
supp3[18,]<-c('MEL',  'Long', format(GCD.12c[3,1],digits=3), format(GCD.12c[3,2],digits=3), format(GCD.12c[3,3], digits=3))

supp3[19,]<-c('THY',  'Short', 1, "reference", "", digits=3)
supp3[20,]<-c('THY',  'Intermediate', format(GCD.14c[2,1],digits=3), format(GCD.14c[2,2],digits=3), format(GCD.14c[2,3],digits=3))
supp3[21,]<-c('THY',  'Long', format(GCD.14c[3,1],digits=3), format(GCD.14c[3,2],digits=3), format(GCD.14c[3,3], digits=3))

supp3[22,]<-c('HN',  'Short', 1, "reference", "", digits=3)
supp3[23,]<-c('HN',  'Intermediate', format(GCD.16c[2,1],digits=3), format(GCD.16c[2,2],digits=3), format(GCD.16c[2,3],digits=3))
supp3[24,]<-c('HN',  'Long', format(GCD.16c[3,1],digits=3), format(GCD.16c[3,2],digits=3), format(GCD.16c[3,3], digits=3))

supp3[25,]<-c('LUNG',  'Short', 1, "reference", "", digits=3)
supp3[26,]<-c('LUNG',  'Intermediate', format(GCD.18c[2,1],digits=3), format(GCD.18c[2,2],digits=3), format(GCD.18c[2,3],digits=3))
supp3[27,]<-c('LUNG',  'Long', format(GCD.18c[3,1],digits=3), format(GCD.18c[3,2],digits=3), format(GCD.18c[3,3], digits=3))

supp3[28,]<-c('BREA',  'Short', 1, "reference", "", digits=3)
supp3[29,]<-c('BREA',  'Intermediate', format(GCD.20c[2,1],digits=3), format(GCD.20c[2,2],digits=3), format(GCD.20c[2,3],digits=3))
supp3[30,]<-c('BREA',  'Long', format(GCD.20c[3,1],digits=3), format(GCD.20c[3,2],digits=3), format(GCD.20c[3,3], digits=3))

supp3[31,]<-c('KID',  'Short', 1, "reference", "", digits=3)
supp3[32,]<-c('KID',  'Intermediate', format(GCD.22c[2,1],digits=3), format(GCD.22c[2,2],digits=3), format(GCD.22c[2,3],digits=3))
supp3[33,]<-c('KID',  'Long', format(GCD.22c[3,1],digits=3), format(GCD.22c[3,2],digits=3), format(GCD.22c[3,3], digits=3))

supp3[34,]<-c('GON',  'Short', 1, "reference", "", digits=3)
supp3[35,]<-c('GON',  'Intermediate', format(GCD.24c[2,1],digits=3), format(GCD.24c[2,2],digits=3), format(GCD.24c[2,3],digits=3))
supp3[36,]<-c('GON',  'Long', format(GCD.24c[3,1],digits=3), format(GCD.24c[3,2],digits=3), format(GCD.24c[3,3], digits=3))

supp3[37,]<-c('CERV',  'Short', 1, "reference", "", digits=3)
supp3[38,]<-c('CERV',  'Intermediate', format(GCD.26c[2,1],digits=3), format(GCD.26c[2,2],digits=3), format(GCD.26c[2,3],digits=3))
supp3[39,]<-c('CERV',  'Long',format(GCD.26c[3,1],digits=3), format(GCD.26c[3,2],digits=3), format(GCD.26c[3,3], digits=3))

supp3[40,]<-c('COL',  'Short', 1, "reference", "", digits=3)
supp3[41,]<-c('COL',  'Intermediate', format(GCD.30c[2,1],digits=3), format(GCD.30c[2,2],digits=3), format(GCD.30c[2,3],digits=3))
supp3[42,]<-c('COL',  'Long', format(GCD.30c[3,1],digits=3), format(GCD.30c[3,2],digits=3), format(GCD.30c[3,3], digits=3))

supp3[43,]<-c('STOM',  'Short', 1, "reference", "", digits=3)
supp3[44,]<-c('STOM',  'Intermediate', format(GCD.32c[2,1],digits=3), format(GCD.32c[2,2],digits=3), format(GCD.32c[2,3],digits=3))
supp3[45,]<-c('STOM',  'Long', format(GCD.32c[3,1],digits=3), format(GCD.32c[3,2],digits=3), format(GCD.32c[3,3], digits=3))

supp3$Cancer_type_f<-as.factor(supp3$`Cancer type`)
#supp2$Cancer_type_f<-as.factor(supp2$`Reporting hospital distance category`)

supp3$OR<-as.numeric(supp3$OR)
supp3$`Lower CI`<-as.numeric(supp3$`Lower CI`)
supp3$`Upper CI`<-as.numeric(supp3$`Upper CI`)
```

#Figure 2 GCD figure
```{r}
ggplot(supp3[which(supp3$`Reporting hospital distance category`!="Short"),],aes(x = `Reporting hospital distance category`, y =`OR`, color=`Reporting hospital distance category`)) +
  geom_point(size = 1)+
  scale_color_manual(values=c("blue", "green"), name="", labels=c("Intermediate (>12.5 to <50 miles) vs. Short (<12.5 miles)","Long (>=50 miles) vs. Short (<12.5 miles)")) +
  ylim(0,4.2) +
   coord_flip() +
  geom_errorbar(aes(ymax = `Lower CI`, ymin = `Upper CI`), width = 0.1)+
  geom_hline(yintercept = 1, color="black", linetype = 1 ) +

theme(axis.title.x = element_text(face="bold"),
      axis.title.y=element_blank(),
       axis.ticks.y=element_blank(),
       axis.text.y=element_blank(),
      axis.text.x=element_text(face="bold"),
      axis.line.x=element_line(size=0.5, colour="black", linetype=1),
      panel.background=element_blank(),
      strip.background=element_rect(), strip.text = element_text(size=8, face="bold", angle=90), legend.position = "bottom", legend.text=element_text(face="bold", size=7))+
  
 facet_wrap(~`Cancer_type_f`, ncol=3, strip.position = "left", dir="v", labeller = labeller(`Cancer type` = label_wrap_gen(10)))+
  ylab("OR (95%CI)") +
  xlab("Cancer type")
ggsave("Figure2.pdf")
```

# Make supp3a and 3b bottom tables output for sex and age category
```{r}
supp3a<-data.frame(matrix(ncol=5, nrow=0))
columns<-c("Sex", "Reporting hospital distance category", "OR", "Lower CI", "Upper CI")
colnames(supp3a)<-columns

supp3a[1,]<-c('Male',  'Short', 1, "reference", "", digits=3)
supp3a[2,]<-c('Male',  'Intermediate', format(GCD.4b[2,1], digits=3), format(GCD.4b[2,2], digits=3), format(GCD.4b[2,3], digits=3))
supp3a[3,]<-c('Male', 'Long', format(GCD.4b[3,1], digits=3), format(GCD.4b[3,2], digits=3), format(GCD.4b[3,3], digits=3))

supp3a[4,]<-c('Female',  'Short', 1, "reference", "", digits=3)
supp3a[5,]<-c('Female',  'Intermediate', format(GCD.6b[2,1], digits=3), format(GCD.6b[2,2], digits=3), format(GCD.6b[2,3], digits=3))
supp3a[6,]<-c('Female', 'Long', format(GCD.6b[3,1], digits=3), format(GCD.6b[3,2], digits=3), format(GCD.6b[3,3], digits=3))

supp3b<-data.frame(matrix(ncol=5, nrow=0))
columns<-c("Age category", "Reporting hospital distance category", "OR", "Lower CI", "Upper CI")
colnames(supp3b)<-columns

supp3b[1,]<-c('15-19 years',  'Short', 1, "reference", "", digits=3)
supp3b[2,]<-c('15-19 years',  'Intermediate', format(GCD.18b[2,1], digits=3), format(GCD.18b[2,2], digits=3), format(GCD.18b[2,3], digits=3))
supp3b[3,]<-c('15-19 years', 'Long', format(GCD.18b[3,1], digits=3), format(GCD.18b[3,2], digits=3), format(GCD.18b[3,3], digits=3))

supp3b[4,]<-c('20-29 years',  'Short', 1, "reference", "", digits=3)
supp3b[5,]<-c('20-29 years',  'Intermediate', format(GCD.20b[2,1], digits=3), format(GCD.20b[2,2], digits=3), format(GCD.20b[2,3], digits=3))
supp3b[6,]<-c('20-29 years', 'Long', format(GCD.20b[3,1], digits=3), format(GCD.20b[3,2], digits=3), format(GCD.20b[3,3], digits=3))

supp3b[7,]<-c('30-39 years',  'Short', 1, "reference", "", digits=3)
supp3b[8,]<-c('30-39 years',  'Intermediate', format(GCD.22b[2,1], digits=3), format(GCD.22b[2,2], digits=3), format(GCD.22b[2,3], digits=3))
supp3b[9,]<-c('30-39 years', 'Long', format(GCD.22b[3,1], digits=3), format(GCD.22b[3,2], digits=3), format(GCD.22b[3,3], digits=3))
```

# Figure 3: Overall mortality in 2015 KM curves
```{r, warning=FALSE}
# Figure 3a RUCC3
RUCC3.surv <- survfit(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead) ~ RUCC3, data=analytic_dt_lb)
survdiff(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ RUCC3, data=analytic_dt_lb)

a<-ggsurvplot(RUCC3.surv, data=analytic_dt_lb,  ylim=c(0.6,1),  size=0.3, conf.int=TRUE, censor=TRUE, font.x="bold", font.y="bold", censor.size=0.5, xlab="Time (months)", tables.theme = clean_theme(),legend.labs = c("Metro", "Urban", "Rural"),
, legend="bottom", legend.title="", font.legend=c(9,"bold")) + guides(colour = guide_legend(nrow = 1))
a

ggsave("figure3a.pdf")

pairwise_survdiff(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ RUCC3, data=analytic_dt_lb, rho = 0)

# Figure 3b GCD
GCD.surv <- survfit(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead) ~ GCD, data=analytic_dt_lb)
survdiff(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ GCD, data=analytic_dt_lb)

b<-ggsurvplot(GCD.surv,  ylim=c(0.6,1),  size=0.3, conf.int=TRUE, censor=TRUE, legend="bottom", legend.title="",legend.labs = c("Short (<= 12.5 miles)", "Intermediate (>12.5 to <50 miles)", "Long (>= 50 miles)"), font.legend=c(9, "bold"), font.x="bold", font.y="bold",  censor.size=0.5, xlab="Time (months)",tables.theme = clean_theme()) + guides(colour = guide_legend(nrow = 1)) 
b
ggsave("figure3b.pdf")

pairwise_survdiff(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ GCD, data=analytic_dt_lb, rho = 0)
```
# Survival by stage for discussion
```{r}
stage.surv <- survfit(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, data=analytic_dt_lb)
survdiff(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, analytic_dt_lb[which(analytic_dt_lb$cantype =="7.1 Melanoma"),])

a<-ggsurvplot(stage.surv, ylim=c(0,1),  size=0.3, conf.int=TRUE, censor=TRUE, legend="bottom", legend.title="", font.x="bold", font.y="bold", censor.size=0.7, xlab="Time (months)", tables.theme = clean_theme(), title="7.1 Melanoma") + guides(colour = guide_legend(nrow = 3)) 
a

stage.surv <- survfit(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, data=analytic_dt_lb)
survdiff(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, analytic_dt_lb[which(analytic_dt_lb$cantype =="8.6.1 Carcinoma of colon and rectum"),])

b<-ggsurvplot(stage.surv, ylim=c(0,1),  size=0.3, conf.int=TRUE, censor=TRUE, legend="bottom", legend.title="", font.x="bold", font.y="bold", censor.size=0.7, xlab="Time (months)", tables.theme = clean_theme(), title="8.6.1 Carcinoma of colon and rectum") + guides(colour = guide_legend(nrow = 3)) 
b

stage.surv <- survfit(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, data=analytic_dt_lb)
survdiff(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, analytic_dt_lb[which(analytic_dt_lb$cantype =="6.1 Germ cell and trophoblastic neoplasms of gonads"),])

c<-ggsurvplot(stage.surv, ylim=c(0,1),  size=0.3, conf.int=TRUE, censor=TRUE, legend="bottom", legend.title="", font.x="bold", font.y="bold", censor.size=0.7, xlab="Time (months)", tables.theme = clean_theme(), title="6.1 Germ cell and trophoblastic neoplasms of gonads") + guides(colour = guide_legend(nrow = 3)) 
c

stage.surv <- survfit(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, data=analytic_dt_lb)
survdiff(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, analytic_dt_lb[which(analytic_dt_lb$cantype =="2.1 Non-Hodgkin lymphoma"),])

d<-ggsurvplot(stage.surv, ylim=c(0,1),  size=0.3, conf.int=TRUE, censor=TRUE, legend="bottom", legend.title="", font.x="bold", font.y="bold", censor.size=0.7, xlab="Time (months)", tables.theme = clean_theme(), title="2.1 Non-Hodgkin lymphoma") + guides(colour = guide_legend(nrow = 3)) 
d

stage.surv <- survfit(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, data=analytic_dt_lb)
survdiff(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, analytic_dt_lb[which(analytic_dt_lb$cantype =="2.2 Hodgkin lymphoma"),])

e<-ggsurvplot(stage.surv, ylim=c(0,1),  size=0.3, conf.int=TRUE, censor=TRUE, legend="bottom", legend.title="", font.x="bold", font.y="bold", censor.size=0.7, xlab="Time (months)", tables.theme = clean_theme(), title="2.2 Hodgkin lymphoma") + guides(colour = guide_legend(nrow = 3)) 
e

stage.surv <- survfit(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, data=analytic_dt_lb)
survdiff(Surv(DX_LASTCONTACT_DEATH_MONTHS,dead) ~ stage, analytic_dt_lb[which(analytic_dt_lb$cantype =="8.1 Thyroid carcinoma"),])

f<-ggsurvplot(stage.surv, ylim=c(0,1),  size=0.3, conf.int=TRUE, censor=TRUE, legend="bottom", legend.title="", font.x="bold", font.y="bold", censor.size=0.7, xlab="Time (months)", tables.theme = clean_theme(), title="8.1 Thyroid carcinoma") + guides(colour = guide_legend(nrow = 3)) 
f
```

# Table 3: Unadjusted Cox PH impact of Rural/Urban on vital status
```{r}
#RUCC3
RUCC3.1d<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3, analytic_dt_lb) 
summary(RUCC3.1d)

#GCD
GCD.1d<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD, analytic_dt_lb) 
summary(GCD.1d)

#sum person years RUCC3
aggregate(analytic_dt_lb$DX_LASTCONTACT_DEATH_MONTHS,  by=list(category=analytic_dt_lb$RUCC3), FUN=sum)
table(analytic_dt_lb$dead, analytic_dt_lb$RUCC3)

#sum person years GCD
aggregate(analytic_dt_lb$DX_LASTCONTACT_DEATH_MONTHS,  by=list(category=analytic_dt_lb$GCD), FUN=sum)
table(analytic_dt_lb$dead, analytic_dt_lb$GCD)
```

# Proportional hazards assumption for unadjusted models
```{r}
#RUCC3
test.phb<-cox.zph(RUCC3.1d, terms=FALSE)
test.phb

ggcoxzph(test.phb)

#GCD
test.phc<-cox.zph(GCD.1d, terms=FALSE)
test.phc

ggcoxzph(test.phc)
```

# Table 3: Adjusted Cox PH impact of Rural/Urban and GCD on vital status
```{r}
#RUCC3
#Adusted for age, sex, race, education, and income
RUCC3.1e<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + AGE + SEX + RACE + educ +income, analytic_dt_lb) 
summary(RUCC3.1e)

#RUCC3 adjust for income and insurance in response to reviewer comments
RUCC3.2e<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + AGE + SEX + RACE + educ + income + insurance, analytic_dt_lb) 
summary(RUCC3.2e)

RUCC3.3e<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + AGE + SEX + RACE + educ + income +stage, analytic_dt_lb) 
summary(RUCC3.3e)

RUCC3.3f<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + AGE + SEX + RACE + educ + income + GCD, analytic_dt_lb) 
summary(RUCC3.3f)


#GCD
#Adusted for age, sex, race, education, and income
GCD.1e<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ +income, analytic_dt_lb) 
summary(GCD.1e)

#Adusted for age, sex, race, education, income and insurance
GCD.2e<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income + insurance , analytic_dt_lb) 
summary(GCD.2e)

#Adjusted for RUCC3
GCD.3e<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income + RUCC3, analytic_dt_lb) 
summary(GCD.3e)

#adjust for stage as a mediator
GCD.4e<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income + stage, analytic_dt_lb) 
summary(GCD.4e)

#Model with crowfly as a linear term in response to reviewer comment
GCD.5e<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~CROWFLY + AGE + SEX + RACE + educ + income, analytic_dt_lb)
summary(GCD.5e)

#Box Tidwell test for linearity
analytic_dt_lb$cf.times.logcf = analytic_dt_lb$CROWFLY * log(analytic_dt_lb$CROWFLY)
GCD.6e<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~CROWFLY + AGE + SEX + RACE + educ + income + cf.times.logcf, analytic_dt_lb) 
summary(GCD.6e)

#create deciles and run deciles as the exposure
analytic_dt_lb$CFdecile<-ntile(analytic_dt_lb$CROWFLY,10)
table(analytic_dt_v$CFdecile)

GCD.7e<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~as.factor(CFdecile) + AGE + SEX + RACE + educ + income, analytic_dt_lb) 
summary(GCD.7e)

summary(analytic_dt_lb[which(analytic_dt_lb$CFdecile==10),]$CROWFLY)

test<-analytic_dt_lb[which(analytic_dt_lb$CFdecile==10),]
```

# Proportional hazards assumption for adjusted models
```{r}
#RUCC3
test.phb<-cox.zph(RUCC3.1e, terms=TRUE)
test.phb

ggcoxzph(test.phb)
plot(test.phb, resid=FALSE)

#GCD
test.phc<-cox.zph(GCD.1e, terms=TRUE)
test.phc

ggcoxzph(test.phc)
plot(test.phc, resid=FALSE)
```

# Supplemenatary Table 4-ph assumption violation models
```{r}
GCD.1f<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + strata(SEX) + strata(RACE) + strata(educ) + strata(income), analytic_dt_lb) 
summary(GCD.1f)

#By time interval to get HRs

#need to change censorship and follow-up time
#0-60 months
analytic_dt_lb$survt60<-ifelse(analytic_dt_lb$DX_LASTCONTACT_DEATH_MONTHS>60, 60, analytic_dt_lb$DX_LASTCONTACT_DEATH_MONTHS)
analytic_dt_lb$status60<-ifelse(analytic_dt_lb$DX_LASTCONTACT_DEATH_MONTHS>60&analytic_dt_lb$dead==1, 0, analytic_dt_lb$dead)

GCD.2f<-coxph(Surv(survt60, status60)~GCD + AGE + strata(SEX) + strata(RACE) + strata(educ) + strata(income), analytic_dt_lb) 
summary(GCD.2f)

GCD.3f<-exp(cbind(HR = coef(GCD.2f), confint(GCD.2f))) #calculate HRs and 95% CIs
  GCD.3f #print HRs and 95% CIs

#>60 months--need to exclude people not at risk
analytic_dt_lb2<-analytic_dt_lb[which(analytic_dt_lb$DX_LASTCONTACT_DEATH_MONTHS>60),]
GCD.4f<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + strata(SEX) + strata(RACE) + strata(educ) + strata(income), analytic_dt_lb2) 
summary(GCD.4f)

#GCD
test.ph60<-cox.zph(GCD.2f, terms=TRUE)
test.ph60

ggcoxzph(test.ph60)
plot(test.ph60, resid=FALSE)

test.phgt60<-cox.zph(GCD.4f)
test.phgt60

ggcoxzph(test.phgt60)
#plot(test.phgt60, resid=FALSE)

supp4<-data.frame(matrix(ncol=4, nrow=0))
columns<-c("Reporting hospital distance", "HR", "lowCI", "UpperCI")
colnames(supp4)<-columns

supp4[1,]<-c("Short", "1.0 (reference)", "", "")
supp4[2,]<-c("Intermediate", format(GCD.3f[1,1], digits=3), format(GCD.3f[1,2], digits=3), format(GCD.3f[1,3], digits=3))
supp4[3,]<-c("Long", format(GCD.3f[2,1], digits=3), format(GCD.3f[2,2], digits=3), format(GCD.3f[2,3], digits=3))
```

# Modification by sex, race, age category, and cancer type
```{r}
# RUCC3
# SEX
RUCC3.1f<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + AGE + SEX + RACE + educ + income, analytic_dt_lb) 
summary(RUCC3.1f)

RUCC3.2f<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + AGE + SEX + RACE + educ + income +  RUCC3*SEX, analytic_dt_lb) 
summary(RUCC3.2f) # no interaction by sex

lrtest(RUCC3.1f, RUCC3.2f)

# RACE
RUCC3.3f<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + AGE + SEX + RACE + educ + income, analytic_dt_lb) 
summary(RUCC3.3f)

RUCC3.4f<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + AGE + SEX + RACE + educ + income +  RUCC3*RACE, analytic_dt_lb) 
summary(RUCC3.4f) # no interaction by RACE

lrtest(RUCC3.3f, RUCC3.4f)

# age category
RUCC3.5f<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + SEX + RACE + educ  + income +  Age_cat2, analytic_dt_lb) 
summary(RUCC3.5f)

RUCC3.6f<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + SEX + RACE + educ + income+ RUCC3*Age_cat2, analytic_dt_lb) 
summary(RUCC3.6f)

lrtest(RUCC3.5f, RUCC3.6f) # no interaction by age category

# How different are the estimates?
# 15-19
RUCC3.7f<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + SEX + RACE + educ + income, analytic_dt_lb[which(analytic_dt_lb$Age_cat2=="15-19"),]) 
summary(RUCC3.7f)

# 20-29
RUCC3.8f<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + SEX + RACE + educ + income , analytic_dt_lb[which(analytic_dt_lb$Age_cat2=="20-29"),]) 
summary(RUCC3.8f)

# 30-39
RUCC3.9f<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + SEX + RACE + educ +income, analytic_dt_lb[which(analytic_dt_lb$Age_cat2=="30-39"),]) 
summary(RUCC3.9f)

# cancer type
RUCC3.10f<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + AGE + SEX + RACE + educ + income +  cantype, analytic_dt_lb) 
summary(RUCC3.10f)

RUCC3.11f<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~RUCC3 + AGE + SEX + RACE + educ + income + RUCC3*cantype, analytic_dt_lb) 
summary(RUCC3.11f)

lrtest(RUCC3.10f, RUCC3.11f) # no interaction by cancer type

# GCD
# SEX
GCD.1g<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ +income, analytic_dt_lb) 
summary(GCD.1g)

GCD.2g<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income+ GCD*SEX, analytic_dt_lb) 
summary(GCD.2g) 

lrtest(GCD.1g, GCD.2g) # no interaction by sex

# RACE
GCD.3g<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income, analytic_dt_lb) 
summary(GCD.3g)

GCD.4g<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income + GCD*RACE, analytic_dt_lb) 
summary(GCD.4g) 

lrtest(GCD.3g, GCD.4g) # no interaction by RACE

# age category
GCD.5g<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + SEX + RACE + educ + income + Age_cat2, analytic_dt_lb) 
summary(GCD.5g)

GCD.6g<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + SEX + RACE + educ + income + Age_cat2 + GCD*Age_cat2, analytic_dt_lb) 
summary(GCD.6g)

lrtest(GCD.5g, GCD.6g)

# How different are the estimates?
# 15-19
GCD.7g<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + SEX + RACE + educ + income, analytic_dt_lb[which(analytic_dt_lb$Age_cat2=="15-19"),]) 
summary(GCD.7g)

# 20-29
GCD.8g<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + SEX + RACE + educ +income, analytic_dt_lb[which(analytic_dt_lb$Age_cat2=="20-29"),]) 
summary(GCD.8g)

# 30-39
GCD.9g<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + SEX + RACE + educ +income, analytic_dt_lb[which(analytic_dt_lb$Age_cat2=="30-39"),]) 
summary(GCD.9g)

# cancer type
GCD.10g<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + + income + cantype, analytic_dt_lb) 
summary(GCD.10g)

GCD.11g<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + +income + cantype + GCD*cantype, analytic_dt_lb) 
summary(GCD.11g)

lrtest(GCD.10g, GCD.11g)

#RUCC3 adjustment and interaction
GCD.12g<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income + RUCC3, analytic_dt_lb) 
summary(GCD.12g)

GCD.13g<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + +income + GCD*RUCC3, analytic_dt_lb) 
summary(GCD.13g)

lrtest(GCD.12g, GCD.13g)
```

# Differences in survival by cancer type in association with GCD
```{r}
# 2.1 Non-Hodgkin lymphoma
GCD.1h<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income, subset=analytic_dt_lb$cantype=="2.1 Non-Hodgkin lymphoma", analytic_dt_lb) 
summary(GCD.1h)

 GCD.2h<-exp(cbind(HR = coef(GCD.1h), confint(GCD.1h))) #calculate HRs and 95% CIs
  GCD.2h #print HRs and 95% CIs
  
#2.2 Hodgkin lymphoma
GCD.3h<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ  + income, subset=analytic_dt_lb$cantype=="2.2 Hodgkin lymphoma", analytic_dt_lb) 
summary(GCD.3h)

 GCD.4h<-exp(cbind(HR = coef(GCD.3h), confint(GCD.3h))) #calculate HRs and 95% CIs
  GCD.4h #print HRs and 95% CIs
  
#4.0 Osseous and chondromatous neoplasms
GCD.5h<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income, subset=analytic_dt_lb$cantype=="4.0 Osseous and chondromatous neoplasms", analytic_dt_lb) 
summary(GCD.5h)

 GCD.6h<-exp(cbind(HR = coef(GCD.5h), confint(GCD.5h))) #calculate HRs and 95% CIs
  GCD.6h #print HRs and 95% CIs
  
#5.0 Soft Tissue Sarcomas 
GCD.7h<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income, subset=analytic_dt_lb$cantype=="5.0 Soft Tissue Sarcomas", analytic_dt_lb) 
summary(GCD.7h)

GCD.8h<-exp(cbind(HR = coef(GCD.7h), confint(GCD.7h))) #calculate HRs and 95% CIs
  GCD.8h #print HRs and 95% CIs

#6.1 Germ cell and trophoblastic neoplasms of gonads 
GCD.9h<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income, subset=analytic_dt_lb$cantype=="6.1 Germ cell and trophoblastic neoplasms of gonads", analytic_dt_lb) 
summary(GCD.9h)
GCD.10h<-exp(cbind(HR = coef(GCD.9h), confint(GCD.9h))) #calculate HRs and 95% CIs
  GCD.10h #print HRs and 95% CIs

#7.1 Melanoma 
GCD.11h<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income, subset=analytic_dt_lb$cantype=="7.1 Melanoma", analytic_dt_lb) 
summary(GCD.11h)
GCD.12h<-exp(cbind(HR = coef(GCD.11h), confint(GCD.11h))) #calculate HRs and 95% CIs
  GCD.12h #print HRs and 95% CIs

#8.1 Thyroid carcinoma
GCD.13h<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ , subset=analytic_dt_lb$cantype=="8.1 Thyroid carcinoma", analytic_dt_lb) 
summary(GCD.13h)

GCD.14h<-exp(cbind(HR = coef(GCD.13h), confint(GCD.13h))) #calculate HRs and 95% CIs
  GCD.14h #print HRs and 95% CIs

#8.2 Carcinoma of head and neck 
GCD.15h<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income, subset=analytic_dt_lb$cantype=="8.2 Carcinoma of head and neck", analytic_dt_lb) 
summary(GCD.15h)
GCD.16h<-exp(cbind(HR = coef(GCD.15h), confint(GCD.15h))) #calculate HRs and 95% CIs
  GCD.16h #print HRs and 95% CIs

#8.3 Carcinoma of trachea,bronchus, and lung 
GCD.17h<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income, subset=analytic_dt_lb$cantype=="8.3 Carcinoma of trachea, bronchus, and lung", analytic_dt_lb) 
summary(GCD.17h)
GCD.18h<-exp(cbind(HR = coef(GCD.17h), confint(GCD.17h))) #calculate HRs and 95% CIs
  GCD.18h #print HRs and 95% CIs
  
#8.4 Carcinoma of breast
GCD.19h<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income, subset=analytic_dt_lb$cantype=="8.4 Carcinoma of breast", analytic_dt_lb) 
summary(GCD.19h)
GCD.20h<-exp(cbind(HR = coef(GCD.19h), confint(GCD.19h))) #calculate HRs and 95% CIs
  GCD.20h #print HRs and 95% CIs
  
#8.5.1 Carcinoma of kidney 
GCD.21h<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income, subset=analytic_dt_lb$cantype=="8.5.1 Carcinoma of kidney", analytic_dt_lb) 
summary(GCD.21h)
GCD.22h<-exp(cbind(HR = coef(GCD.21h), confint(GCD.21h))) #calculate HRs and 95% CIs
  GCD.22h #print HRs and 95% CIs

#8.5.3 Carcinoma of gonads
GCD.23h<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income, subset=analytic_dt_lb$cantype=="8.5.3 Carcinoma of gonads", analytic_dt_lb) 
summary(GCD.23h)
GCD.24h<-exp(cbind(HR = coef(GCD.23h), confint(GCD.23h))) #calculate HRs and 95% CIs
  GCD.24h #print HRs and 95% CIs
  
#8.5.4 Carcinoma of cervix 
GCD.25h<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income, subset=analytic_dt_lb$cantype=="8.5.4 Carcinoma of cervix", analytic_dt_lb) 
summary(GCD.25h)
GCD.26h<-exp(cbind(HR = coef(GCD.25h), confint(GCD.25h))) #calculate HRs and 95% CIs
  GCD.26h #print HRs and 95% CIs

#including insurance in the model in response to a reviewer comment
 GCD.27h<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income + insurance, subset=analytic_dt_lb$cantype=="8.5.4 Carcinoma of cervix", analytic_dt_lb) 
summary(GCD.27h)
GCD.28h<-exp(cbind(HR = coef(GCD.27h), confint(GCD.27h))) #calculate HRs and 95% CIs
  GCD.28h #print HRs and 95% CIs
  
#8.6.1 Carcinoma of colon and rectum
GCD.29h<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income, subset=analytic_dt_lb$cantype=="8.6.1 Carcinoma of colon and rectum", analytic_dt_lb) 
summary(GCD.29h)
 GCD.30h<-exp(cbind(HR = coef(GCD.29h), confint(GCD.29h))) #calculate HRs and 95% CIs
  GCD.30h #print HRs and 95% CIs
  
#8.6.2 Carcinoma of stomach 
GCD.31h<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income, subset=analytic_dt_lb$cantype=="8.6.2 Carcinoma of stomach", analytic_dt_lb) 
summary(GCD.31h)
GCD.32h<-exp(cbind(HR = coef(GCD.31h), confint(GCD.31h))) #calculate HRs and 95% CIs
  GCD.32h #print HRs and 95% CIs
  
#Brain
GCD.33h<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income, subset=analytic_dt_lb$cantype=="3.0 CNS and Other Intracranial and Intraspinal Neoplasms (all behaviors)", analytic_dt_lb) 
summary(GCD.33h)
GCD.34h<-exp(cbind(HR = coef(GCD.33h), confint(GCD.33h))) #calculate HRs and 95% CIs
  GCD.34h #print HRs and 95% CIs
  
#Leukemia
GCD.35h<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income, subset=analytic_dt_lb$cantype=="1.0 Leukemias", analytic_dt_lb) 
summary(GCD.35h)
GCD.36h<-exp(cbind(HR = coef(GCD.35h), confint(GCD.35h))) #calculate HRs and 95% CIs
  GCD.36h #print HRs and 95% CIs
```


# Supplementary Table 5
```{r}
#make empty data frame
supp5<-data.frame(matrix(ncol=5, nrow=0))
columns<-c("Cancer type", "Reporting hospital distance category","HR", "LowerCI", "UpperCI")
colnames(supp5)<-columns

supp5[1,]<-c('NHL','Short', 1.0, "reference", "", digits=3)
supp5[2,]<-c('NHL',  'Intermediate', format(GCD.2h[1,1], digits=3), format(GCD.2h[1,2], digits=3), format(GCD.2h[1,3], digits=3))
supp5[3,]<-c('NHL',  'Long', format(GCD.2h[2,1], digits=3), format(GCD.2h[2,2], digits=3), format(GCD.2h[2,3], digits=3))

supp5[4,]<-c('HL','Short', 1.0, "reference", "", digits=3)
supp5[5,]<-c('HL',  'Intermediate', format(GCD.4h[1,1], digits=3), format(GCD.4h[1,2], digits=3), format(GCD.4h[1,3], digits=3))
supp5[6,]<-c('HL',  'Long', format(GCD.4h[2,1], digits=3), format(GCD.4h[2,2], digits=3), format(GCD.4h[2,3], digits=3))

supp5[7,]<-c('OS','Short', 1.0, "reference", "", digits=3)
supp5[8,]<-c('OS',  'Intermediate', format(GCD.6h[1,1], digits=3), format(GCD.6h[1,2], digits=3), format(GCD.6h[1,3], digits=3))
supp5[9,]<-c('OS',  'Long', format(GCD.6h[2,1], digits=3), format(GCD.6h[2,2], digits=3), format(GCD.6h[2,3], digits=3))

supp5[10,]<-c('STS','Short', 1.0, "reference", "", digits=3)
supp5[11,]<-c('STS',  'Intermediate', format(GCD.8h[1,1], digits=3), format(GCD.8h[1,2], digits=3), format(GCD.8h[1,3], digits=3))
supp5[12,]<-c('STS',  'Long', format(GCD.8h[2,1], digits=3), format(GCD.8h[2,2], digits=3), format(GCD.8h[2,3], digits=3))

supp5[13,]<-c('GCT','Short', 1.0, "reference", "", digits=3)
supp5[14,]<-c('GCT',  'Intermediate', format(GCD.10h[1,1], digits=3), format(GCD.10h[1,2], digits=3), format(GCD.10h[1,3], digits=3))
supp5[15,]<-c('GCT',  'Long', format(GCD.10h[2,1], digits=3), format(GCD.10h[2,2], digits=3), format(GCD.10h[2,3], digits=3))

supp5[16,]<-c('MEL','Short', 1.0, "reference", "", digits=3)
supp5[17,]<-c('MEL',  'Intermediate', format(GCD.12h[1,1], digits=3), format(GCD.12h[1,2], digits=3), format(GCD.12h[1,3], digits=3))
supp5[18,]<-c('MEL',  'Long', format(GCD.12h[2,1], digits=3), format(GCD.12h[2,2], digits=3), format(GCD.12h[2,3], digits=3))

supp5[19,]<-c('THY','Short', 1.0, "reference", "", digits=3)
supp5[20,]<-c('THY',  'Intermediate', format(GCD.14h[1,1], digits=3), format(GCD.14h[1,2], digits=3), format(GCD.14h[1,3], digits=3))
supp5[21,]<-c('THY',  'Long', format(GCD.14h[2,1], digits=3), format(GCD.14h[2,2], digits=3), format(GCD.14h[2,3], digits=3))

supp5[22,]<-c('HN','Short', 1.0, "reference", "", digits=3)
supp5[23,]<-c('HN',  'Intermediate', format(GCD.16h[1,1], digits=3), format(GCD.16h[1,2], digits=3), format(GCD.16h[1,3], digits=3))
supp5[24,]<-c('HN',  'Long', format(GCD.16h[2,1], digits=3), format(GCD.16h[2,2], digits=3), format(GCD.16h[2,3], digits=3))

supp5[25,]<-c('LUNG','Short', 1.0, "reference", "", digits=3)
supp5[26,]<-c('LUNG',  'Intermediate', format(GCD.18h[1,1], digits=3), format(GCD.18h[1,2], digits=3), format(GCD.18h[1,3], digits=3))
supp5[27,]<-c('LUNG',  'Long', format(GCD.18h[2,1], digits=3), format(GCD.18h[2,2], digits=3), format(GCD.18h[2,3], digits=3))

supp5[28,]<-c('BREA','Short', 1.0, "reference", "", digits=3)
supp5[29,]<-c('BREA',  'Intermediate', format(GCD.20h[1,1], digits=3), format(GCD.20h[1,2], digits=3), format(GCD.20h[1,3], digits=3))
supp5[30,]<-c('BREA',  'Long', format(GCD.20h[2,1], digits=3), format(GCD.20h[2,2], digits=3), format(GCD.20h[2,3], digits=3))

supp5[31,]<-c('KID','Short', 1.0, "reference", "", digits=3)
supp5[32,]<-c('KID',  'Intermediate', format(GCD.22h[1,1], digits=3), format(GCD.22h[1,2], digits=3), format(GCD.22h[1,3], digits=3))
supp5[33,]<-c('KID',  'Long', format(GCD.22h[2,1], digits=3), format(GCD.22h[2,2], digits=3), format(GCD.22h[2,3], digits=3))

supp5[34,]<-c('GON','Short', 1.0, "reference", "", digits=3)
supp5[35,]<-c('GON',  'Intermediate', format(GCD.24h[1,1], digits=3), format(GCD.24h[1,2], digits=3), format(GCD.24h[1,3], digits=3))
supp5[36,]<-c('GON',  'Long', format(GCD.24h[2,1], digits=3), format(GCD.24h[2,2], digits=3), format(GCD.24h[2,3], digits=3))

supp5[37,]<-c('CERV','Short', 1.0, "reference", "", digits=3)
supp5[38,]<-c('CERV',  'Intermediate', format(GCD.26h[1,1], digits=3), format(GCD.26h[1,2], digits=3), format(GCD.26h[1,3], digits=3))
supp5[39,]<-c('CERV',  'Long', format(GCD.26h[2,1], digits=3), format(GCD.26h[2,2], digits=3), format(GCD.26h[2,3], digits=3))

supp5[40,]<-c('COL','Short', 1.0, "reference", "", digits=3)
supp5[41,]<-c('COL',  'Intermediate', format(GCD.30h[1,1], digits=3), format(GCD.30h[1,2], digits=3), format(GCD.30h[1,3], digits=3))
supp5[42,]<-c('COL',  'Long', format(GCD.30h[2,1], digits=3), format(GCD.30h[2,2], digits=3), format(GCD.30h[2,3], digits=3))

supp5[43,]<-c('STOM','Short', 1.0, "reference", "", digits=3)
supp5[44,]<-c('STOM',  'Intermediate', format(GCD.32h[1,1], digits=3), format(GCD.32h[1,2], digits=3), format(GCD.32h[1,3], digits=3))
supp5[45,]<-c('STOM',  'Long', format(GCD.32h[2,1], digits=3), format(GCD.32h[2,2], digits=3), format(GCD.32h[2,3], digits=3))

supp5[46,]<-c('CNS','Short', 1.0, "reference", "", digits=3)
supp5[47,]<-c('CNS', 'Intermediate',  format(GCD.34h[1,1], digits=3), format(GCD.34h[1,2], digits=3), format(GCD.34h[1,3], digits=3))
supp5[48,]<-c('CNS',  'Long', format(GCD.34h[2,1], digits=3), format(GCD.34h[2,2], digits=3), format(GCD.34h[2,3], digits=3))

supp5[49,]<-c('LEUK','Short', 1.0, "reference", "", digits=3)
supp5[50,]<-c('LEUK', 'Intermediate',  format(GCD.36h[1,1], digits=3), format(GCD.36h[1,2], digits=3), format(GCD.36h[1,3], digits=3))
supp5[51,]<-c('LEUK',  'Long', format(GCD.36h[2,1], digits=3), format(GCD.36h[2,2], digits=3), format(GCD.36h[2,3], digits=3))

supp5$Cancer_type_f=factor(supp5$`Cancer type`, labels=c("BREA", "CERV", "CNS", "COL","GCT","GON", "HL","HN","KID","LEUK", "LUNG", "MEL", "NHL", "OS", "STOM", "STS", "THY"))
supp5$HR<-as.numeric(supp5$HR)
supp5$LowerCI<-as.numeric(supp5$LowerCI)
supp5$UpperCI<-as.numeric(supp5$UpperCI)

```

# Figure 4
```{r}
#GCD figure
ggplot(supp5[which(supp5$LowerCI !="reference"),],aes(x = `Reporting hospital distance category`, y =`HR`, color=`Reporting hospital distance category`)) +
  geom_point(size = 1)+
  scale_color_manual(values=c("blue", "green"), name="", labels=c("Intermediate  (>12.5 to <50 miles) vs. Short (<=12.5 miles)","Long (>=50 miles) vs. Short (<=12.5 miles)"))+
  ylim(0.5,3.5) +
   coord_flip() +
  geom_errorbar(aes(ymax = LowerCI, ymin = UpperCI), width = 0.1)+
  geom_hline(yintercept = 1, color="black", linetype = 1 ) +

theme(axis.title.y=element_blank(),
       axis.ticks.y=element_blank(),
       axis.text.y=element_blank(),
      axis.title.x = element_text(face="bold"),
      axis.text.x = element_text(face="bold"),
      panel.background=element_blank(),
       axis.line.x=element_line(size = 0.5, colour = "black", linetype=1),
      strip.background=element_rect(), strip.text = element_text(size=8, face="bold", angle=180), legend.position = "bottom", legend.text=element_text(face="bold"), legend.text.align = 0) +

 facet_wrap(~`Cancer_type_f`, ncol=3, strip.position = "left", dir="v", labeller = labeller(`Cancer type` = label_wrap_gen(10)))+
  ylab("HR (95%CI)") +
  xlab("Cancer type")
ggsave("Figure4.pdf")

wb<-createWorkbook()
addWorksheet(wb, sheetName="Supplementary Table 3")
writeData(wb, sheet="Supplementary Table 3", x=supp3)
addWorksheet(wb, sheetName="Supplementary Table 3a")
writeData(wb, sheet="Supplementary Table 3a", x=supp3a)
addWorksheet(wb, sheetName="Supplementary Table 3b")
writeData(wb, sheet="Supplementary Table 3b", x=supp3b)
addWorksheet(wb, sheetName="Supplementary Table 4")
writeData(wb, sheet="Supplementary Table 4", x=supp4)
addWorksheet(wb, sheetName="Supplementary Table 5")
writeData(wb, sheet="Supplementary Table 5", x=supp5)
saveWorkbook(wb, "Supplementary Tables.xlsx", overwrite=TRUE)
```

# Supplementary Table 6
```{r}
table1(~cantype|GCD*as.factor(dead), analytic_dt_lb)
table1(~Age_cat2|GCD*as.factor(dead), analytic_dt_lb)
```

# For reviewer comment about CNS, cervical and OS
```{r}
#Per PMID https://link-springer-com.libproxy.wustl.edu/article/10.1007/s11060-018-03022-wfor brain tumors, divide patients into low and high volume facilities

facility_vol_cns<-as.data.frame(table(analytic_dt_lb[which(analytic_dt_lb$cantype=="3.0 CNS and Other Intracranial and Intraspinal Neoplasms (all behaviors)"),]$PUF_FACILITY_ID))

colnames(facility_vol_cns)<-c("PUF_FACILITY_ID", "CNS_VOL")

CNS<-analytic_dt_lb[which(analytic_dt_lb$cantype=="3.0 CNS and Other Intracranial and Intraspinal Neoplasms (all behaviors)"),]

#merge CNS and facility_vol_cns by PUF_FACILITY_ID

CNS<-merge(CNS, facility_vol_cns, by="PUF_FACILITY_ID")

help(merge)

summary(CNS$CNS_VOL)

CNS$vol_quartile[CNS$CNS_VOL<=10]<-0
CNS$vol_quartile[CNS$CNS_VOL>10 & CNS$CNS_VOL<26]<-1
CNS$vol_quartile[CNS$CNS_VOL>=26 & CNS$CNS_VOL<61]<-2
CNS$vol_quartile[CNS$CNS_VOL>=61]<-3

CNS$vol_quartile<-factor(CNS$vol_quartile, levels=c(0:3), labels=c("Q1", "Q2", "Q3", "Q4"))

# look at means by distance
summary(CNS[which(CNS$GCD=="Short"),]$CNS_VOL)
sd(CNS[which(CNS$GCD=="Short"),]$CNS_VOL)
summary(CNS[which(CNS$GCD=="Intermediate"),]$CNS_VOL)
sd(CNS[which(CNS$GCD=="Intermediate"),]$CNS_VOL)
summary(CNS[which(CNS$GCD=="Long"),]$CNS_VOL)
sd(CNS[which(CNS$GCD=="Long"),]$CNS_VOL)

CNS$logCNS_VOL<-log(CNS$CNS_VOL)

#linear model
GCD.1i<-lm(CNS_VOL~GCD, CNS)
summary(GCD.1i)

CNS_VOL_log<-lm(logCNS_VOL~GCD, CNS)
summary(CNS_VOL_log)

ols_plot_resid_qq(GCD.1i)
ols_plot_resid_qq(CNS_VOL_log)

#adjust CNS results by vol_quartile
#Brain

GCD.2i<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ +income, CNS) 
summary(GCD.2i)
GCD.3i<-exp(cbind(HR = coef(GCD.2i), confint(GCD.2i))) #calculate HRs and 95% CIs
  GCD.3i #print HRs and 95% CIs
  
GCD.4i<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income+ CNS$vol_quartile, CNS) 
summary(GCD.4i)
GCD.5i<-exp(cbind(HR = coef(GCD.4i), confint(GCD.4i))) #calculate HRs and 95% CIs
  GCD.5i #print HRs and 95% CIs

#What is the association between CNS tumor volume and facility?
vol_quartile.1a<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~vol_quartile + AGE + SEX + RACE + educ + income, CNS) 
summary(vol_quartile.1a)

#look at EM by volume quartile
vol_quartile.2a<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income+ vol_quartile + GCD*vol_quartile, CNS) 
summary(vol_quartile.2a)

lrtest(vol_quartile.1a, vol_quartile.2a)

GCD.6i<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income, CNS[which(CNS$vol_quartile=="Q1"),]) 
summary(GCD.6i)
GCD.7i<-exp(cbind(HR = coef(GCD.6i), confint(GCD.6i))) #calculate HRs and 95% CIs
  GCD.7i #print HRs and 95% CIs

GCD.8i<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income, CNS[which(CNS$vol_quartile=="Q2"),]) 
summary(GCD.8i)
GCD.9i<-exp(cbind(HR = coef(GCD.8i), confint(GCD.8i))) #calculate HRs and 95% CIs
  GCD.9i #print HRs and 95% CIs
  
GCD.10i<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income, CNS[which(CNS$vol_quartile=="Q3"),]) 
summary(GCD.10i)
GCD.11i<-exp(cbind(HR = coef(GCD.10i), confint(GCD.10i))) #calculate HRs and 95% CIs
  GCD.11i #print HRs and 95% CIs
  
GCD.12i<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income, CNS[which(CNS$vol_quartile=="Q4"),]) 
summary(GCD.12i)
GCD.13i<-exp(cbind(HR = coef(GCD.12i), confint(GCD.12i))) #calculate HRs and 95% CIs
  GCD.13i #print HRs and 95% CIs
  

##### Cervical cancer 
  
facility_vol_cerv<-as.data.frame(table(analytic_dt_v[which(analytic_dt_v$cantype=="8.5.4 Carcinoma of cervix"),]$PUF_FACILITY_ID))

colnames(facility_vol_cerv)<-c("PUF_FACILITY_ID", "CERV_VOL")

CERV<-analytic_dt_v[which(analytic_dt_v$cantype=="8.5.4 Carcinoma of cervix"),]

#merge cervical cancer and facility_vol_cns by PUF_FACILITY_ID

CERV<-merge(CERV, facility_vol_cerv, by="PUF_FACILITY_ID")

help(merge)

summary(CERV$CERV_VOL)

CERV$vol_quartile[CERV$CERV_VOL<=10]<-0
CERV$vol_quartile[CERV$CERV_VOL>10 & CERV$CERV_VOL<19]<-1
CERV$vol_quartile[CERV$CERV_VOL>=19 & CERV$CERV_VOL<31]<-2
CERV$vol_quartile[CERV$CERV_VOL>=31]<-3

CERV$vol_quartile<-factor(CERV$vol_quartile, levels=c(0:3), labels=c("Q1", "Q2", "Q3", "Q4"))

# look at means by distance
summary(CERV[which(CERV$GCD=="Short"),]$CERV_VOL)
sd(CERV[which(CERV$GCD=="Short"),]$CERV_VOL)
summary(CERV[which(CERV$GCD=="Intermediate"),]$CERV_VOL)
sd(CERV[which(CERV$GCD=="Intermediate"),]$CERV_VOL)
summary(CERV[which(CERV$GCD=="Long"),]$CERV_VOL)
sd(CERV[which(CERV$GCD=="Long"),]$CERV_VOL)

CERV$logCERV_VOL<-log(CERV$CERV_VOL)

CERV_VOL<-lm(CERV_VOL~GCD, CERV)
summary(CERV_VOL)

CERV_VOL_log<-lm(logCERV_VOL~GCD, CERV)
summary(CERV_VOL_log)

ols_plot_resid_qq(CERV_VOL)
ols_plot_resid_qq(CERV_VOL_log)

#GCD
GCD.14i<-glm(stage_binary ~ GCD + RACE +AGE  + educ +income, family = "binomial", data = CERV)
summary(GCD.14i)

GCD.15i<-exp(cbind(OR = coef(GCD.14i), confint(GCD.14i))) #calculate ORs and 95% CIs
  GCD.15i#print ORs and 95% CIs
  
GCD.16i<-glm(stage_binary ~ GCD + RACE +AGE  + educ +income + vol_quartile, family = "binomial", data = CERV)
summary(GCD.16i)

GCD.17i<-exp(cbind(OR = coef(GCD.16i), confint(GCD.16i))) #calculate ORs and 95% CIs
  GCD.17i#print ORs and 95% CIs

#add insurance
GCD.18i<-glm(stage_binary ~ GCD + RACE +AGE  + educ +income + insurance + vol_quartile, family = "binomial", data = CERV)
summary(GCD.18i)

GCD.19i<-exp(cbind(OR = coef(GCD.18i), confint(GCD.18i))) #calculate ORs and 95% CIs
  GCD.19i#print ORs and 95% CIs
  
GCD.20i<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ +income, CERV) 
summary(GCD.20i)

GCD.21i<-exp(cbind(HR = coef(GCD.20i), confint(GCD.20i))) #calculate HRs and 95% CIs
  GCD.21i#print HRs and 95% CIs
  
GCD.22i<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income+ vol_quartile, CERV) 
summary(GCD.22i)
GCD.23i<-exp(cbind(HR = coef(GCD.22i), confint(GCD.22i))) #calculate HRs and 95% CIs
  GCD.23i #print HRs and 95% CIs
  
#also adjust for insurance
GCD.24i<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~GCD + AGE + SEX + RACE + educ + income+ insurance + vol_quartile, CERV) 
summary(GCD.24i)
GCD.25i<-exp(cbind(HR = coef(GCD.24i), confint(GCD.24i))) #calculate HRs and 95% CIs
  GCD.25i #print HRs and 95% CIs
  
#Is there an association between cervical cancer vol_quartile and overall survival?
GCD.26i<-glm(stage_binary ~ vol_quartile + RACE +AGE  + educ +income + vol_quartile, family = "binomial", data = CERV)
summary(GCD.26i)
odds.n.ends(GCD.26i)

modelCerv_vol<-coxph(Surv(DX_LASTCONTACT_DEATH_MONTHS, dead)~vol_quartile + AGE + SEX + RACE + educ +income, CERV) 
summary(modelCerv_vol)

#look at EM by volume quartile for stage
GCD.27i<-glm(stage_binary ~ GCD + RACE +AGE  + educ +income + vol_quartile, family = "binomial", data = CERV)
summary(GCD.27i)

GCD.28i<-glm(stage_binary ~ GCD + RACE +AGE  + educ +income + vol_quartile + GCD*vol_quartile, family = "binomial", data = CERV)
summary(GCD.28i)

lrtest(GCD.27i, GCD.28i)

#Stratify by quartile
GCD.29i<-glm(stage_binary ~ GCD + RACE +AGE  + educ +income, family = "binomial", data = CERV[which(CERV$vol_quartile=="Q1"),])
summary(GCD.29i)
odds.n.ends(GCD.29i)

GCD.30i<-glm(stage_binary ~ GCD + RACE +AGE  + educ +income, family = "binomial", data = CERV[which(CERV$vol_quartile=="Q2"),])
summary(GCD.30i)
odds.n.ends(GCD.30i)

GCD.31i<-glm(stage_binary ~ GCD + RACE +AGE  + educ +income, family = "binomial", data = CERV[which(CERV$vol_quartile=="Q3"),])
summary(GCD.31i)
odds.n.ends(GCD.31i)

GCD.32i<-glm(stage_binary ~ GCD + RACE +AGE  + educ +income, family = "binomial", data = CERV[which(CERV$vol_quartile=="Q4"),])
summary(GCD.32i)
odds.n.ends(GCD.32i)

##### 4.0 Osseous and chondromatous neoplasms
  
facility_vol_OS<-as.data.frame(table(analytic_dt_v[which(analytic_dt_v$cantype=="4.0 Osseous and chondromatous neoplasms"),]$PUF_FACILITY_ID))

colnames(facility_vol_OS)<-c("PUF_FACILITY_ID", "OS_VOL")

OS<-analytic_dt_v[which(analytic_dt_v$cantype=="4.0 Osseous and chondromatous neoplasms"),]

#merge OS and facility_vol_cns by PUF_FACILITY_ID

OS<-merge(OS, facility_vol_OS, by="PUF_FACILITY_ID")


summary(OS$OS_VOL)

OS$vol_quartile[OS$OS_VOL<=10]<-0
OS$vol_quartile[OS$OS_VOL>10 & OS$OS_VOL<19]<-1
OS$vol_quartile[OS$OS_VOL>=19 & OS$OS_VOL<31]<-2
OS$vol_quartile[OS$OS_VOL>=31]<-3

OS$vol_quartile<-factor(OS$vol_quartile, levels=c(0:3), labels=c("Q1", "Q2", "Q3", "Q4"))

# look at means by distance
summary(OS[which(OS$GCD=="Short"),]$OS_VOL)
sd(OS[which(OS$GCD=="Short"),]$OS_VOL)
summary(OS[which(OS$GCD=="Intermediate"),]$OS_VOL)
sd(OS[which(OS$GCD=="Intermediate"),]$OS_VOL)
summary(OS[which(OS$GCD=="Long"),]$OS_VOL)
sd(OS[which(OS$GCD=="Long"),]$OS_VOL)

OS$logOS_VOL<-log(OS$OS_VOL)

OS_VOL<-lm(OS_VOL~GCD, OS)
summary(OS_VOL)

OS_VOL_log<-lm(logOS_VOL~GCD, OS)
summary(OS_VOL_log)

ols_plot_resid_qq(OS_VOL)
ols_plot_resid_qq(OS_VOL_log)

#GCD
GCD.33i<-glm(stage_binary ~ GCD + RACE +AGE  + educ + income, family = "binomial", data = OS)
summary(GCD.33i)
odds.n.ends(GCD.33i)

GCD.34i<-glm(stage_binary ~ GCD + RACE +AGE  + educ + income + vol_quartile, family = "binomial", data = OS)
summary(GCD.34i)
odds.n.ends(GCD.34i)
  
GCD.35i<-glm(stage_binary ~ GCD + RACE +AGE  + educ +income + insurance + vol_quartile, family = "binomial", data = OS)
summary(GCD.35i)
odds.n.ends(GCD.35i)

```



